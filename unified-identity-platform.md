# 统一身份平台架构设计

> 跨产品统一用户身份与资源共享平台设计方案

## 1. 架构设计方案

### 1.1 架构名称与原理

**架构名称：统一身份平台 (Unified Identity Platform, UIP)**

该架构在业界也被称为：

- **身份即服务 (Identity as a Service, IDaaS)** - 将身份管理作为独立服务提供
- **集中式身份管理 (Centralized Identity Management)** - 统一管理所有产品的用户身份
- **单点登录平台 (Single Sign-On Platform)** - 一次登录，全平台通用
- **跨产品身份联邦 (Cross-Product Identity Federation)** - 多产品共享身份体系

#### 核心原理

```
┌─────────────────────────────────────────────────────────────────┐
│                       统一身份平台                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   用户身份   │  │  积分钱包   │  │   资源账本（配额/权益）  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                ┌─────────────────────────┐
                │    Moryflow (核心产品)   │
                │   笔记 AI 工作流 + 发布  │
                └─────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
        ┌───────────┐   ┌───────────┐   ┌───────────┐
        │  Fetchx   │   │   Memox   │   │   Sandx   │
        │ (网页抓取) │   │ (AI 记忆) │   │(Agent沙盒)│
        └───────────┘   └───────────┘   └───────────┘
              ↑               ↑               ↑
              └───────────────┴───────────────┘
                        原子能力层
```

**产品矩阵定位**：

- **Moryflow**（核心产品）：笔记 AI 工作流 + 网站发布，调用下层原子能力
- **原子能力**：Fetchx（网页抓取）、Memox（AI 记忆）、Sandx（Agent 沙盒）

**核心思想**：将用户身份、积分钱包、资源配额从各个业务系统中抽离出来，形成一个独立的「身份平台」。各业务系统通过统一的网关 API 来：

1. 验证用户身份（这个用户是谁？）
2. 查询用户权益（这个用户能用什么功能？）
3. 扣减/查询积分（这个用户还有多少积分？）

> **命名说明**：
>
> - **Moryflow**：核心产品名称，保持不变（主域名 moryflow.com / moryflow.app）
> - **Fetchx**：原名 AIGET，因与公司名 Aiget 冲突而更名
> - **Memox**：原名 MEMAI，统一为 `*x` 品牌风格
> - **Sandx**：Agent Sandbox 简化，规划中的 Agent 沙盒服务
> - **Aiget**：统一平台基础设施（API 服务统一使用 *.aiget.dev 子域名）

#### 域名规划

| 服务                | 域名                  | 说明                               |
| ------------------- | --------------------- | ---------------------------------- |
| **Moryflow 主站**   | moryflow.com          | 核心产品主入口                     |
| **Moryflow 发布站** | moryflow.app          | 用户发布的网站                     |
| **Aiget 平台**      | aiget.dev             | 统一平台入口                       |
| **统一控制台**      | console.aiget.dev     | 用户管理所有产品                   |
| **统一管理后台**    | admin.aiget.dev       | 运营管理                           |
| **统一文档**        | docs.aiget.dev        | 文档站                             |
| **Moryflow API**    | moryflow.aiget.dev    | 核心产品 API 服务                  |
| **Fetchx API**      | fetchx.aiget.dev      | 原子能力：网页抓取（路径 `/v1/...`）|
| **Memox API**       | memox.aiget.dev       | 原子能力：AI 记忆（路径 `/v1/...`）|
| **Sandx API**       | sandx.aiget.dev       | 原子能力：Agent 沙盒（规划中）     |

> - **Moryflow** 是核心产品，拥有独立域名 moryflow.com / moryflow.app
> - **Aiget** 是基础设施平台，所有 API 服务统一使用 *.aiget.dev 子域名
> - **路径规范**：`{product}.aiget.dev/v1/...`（无 `/api` 前缀）

#### API Key 前缀

| 前缀  | 产品     | 访问范围                        |
| ----- | -------- | ------------------------------- |
| `ag_` | 全平台   | 所有产品（Moryflow + 原子能力） |
| `mf_` | Moryflow | 核心产品：笔记 AI 工作流        |
| `fx_` | Fetchx   | 原子能力：网页抓取              |
| `mx_` | Memox    | 原子能力：AI 记忆               |
| `sx_` | Sandx    | 原子能力：Agent 沙盒            |

#### 架构分层

| 层级       | 职责                         | 核心组件                                                                 |
| ---------- | ---------------------------- | ------------------------------------------------------------------------ |
| **身份层** | 用户认证、会话管理、个人资料 | User（用户）、Session（会话）、Account（账号）、Profile（资料）          |
| **钱包层** | 通用积分/Credits 管理        | Wallet（钱包）、WalletTransaction（交易记录）、PurchaseOrder（购买订单） |
| **权益层** | 订阅权益、产品授权           | Subscription（订阅）、ProductEntitlement（产品权益）、License（许可证）  |
| **网关层** | 对外 API、Token 校验         | 认证 API、资源 API、Webhook                                              |
| **产品层** | 各业务系统                   | Moryflow（核心）、Fetchx、Memox、Sandx（原子能力）                       |

### 1.2 核心优势分析

#### 优势一：单一数据源 (Single Source of Truth)

```
改造前（分散式）：                    改造后（统一式）：
┌─────────┐ ┌─────────┐ ┌─────────┐  ┌─────────────────────┐
│ Fetchx  │ │ Memox   │ │Moryflow │  │     统一身份平台     │
│ ─────── │ │ ─────── │ │ ─────── │  │   ─────────────────  │
│ 用户表  │ │ 用户表  │ │ 用户表  │  │   用户表（唯一）     │
│ 配额表  │ │ 配额表  │ │ 积分表  │  │   钱包（统一）       │
│ 订阅表  │ │ 订阅表  │ │ 订阅表  │  │   订阅（统一）       │
└─────────┘ └─────────┘ └─────────┘  └─────────────────────┘
     ×3 套用户表                           1 套用户表
     ×3 套配额系统                         1 套钱包系统
     ×3 套支付对接                         1 套支付系统
```

**具体收益**：

- 用户只需注册一次，即可使用所有产品
- 积分/Credits 跨产品共享，可在任意产品消费
- 统一的支付入口，简化财务对账
- 避免同一用户在不同产品有不同的身份数据

#### 优势二：运营效率提升

| 场景     | 改造前（分散式）               | 改造后（统一式）     |
| -------- | ------------------------------ | -------------------- |
| 用户注册 | 每个产品单独注册，记住多套账号 | 一次注册，全平台通用 |
| 密码重置 | 每个产品单独处理               | 统一入口处理         |
| 积分充值 | 每个产品单独充值，不能互通     | 统一钱包，跨产品使用 |
| 订阅管理 | 每个产品单独订阅               | 统一订阅中心         |
| 用户支持 | 客服需要登录多系统查询用户状态 | 单一控制台查看全貌   |

#### 优势三：产品协同与交叉销售

```
用户旅程示例：
┌─────────────────────────────────────────────────────────────┐
│  1. 用户通过 Fetchx（网页抓取）注册                          │
│  2. 购买 10,000 积分（$10）                                 │
│  3. 使用 3,000 积分进行网页抓取                             │
│  4. 发现 Memox（AI记忆）→ 已自动登录（单点登录）            │
│  5. 使用剩余 7,000 积分存储记忆数据                         │
│  6. 发现 Moryflow（工作流）→ 已自动登录                     │
│  7. 积分余额在所有产品中统一显示                            │
└─────────────────────────────────────────────────────────────┘
```

**交叉销售收益**：

- 用户在一个产品购买的积分，可以吸引其尝试其他产品
- 降低新产品的获客成本（已有用户直接使用）
- 提高用户粘性（积分余额激励持续使用）
- 用户生命周期价值 (LTV) 提升

#### 优势四：技术收益

| 收益           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| **代码复用**   | Auth（认证）、Payment（支付）、Quota（配额）逻辑只需维护一份 |
| **安全集中化** | 安全漏洞修复一处，全平台生效                                 |
| **独立扩展**   | 身份服务可独立扩展，不受业务服务影响                         |
| **审计追踪**   | 统一的操作日志，便于合规审计                                 |
| **A/B 测试**   | 可在平台层面实施跨产品实验                                   |

#### 优势五：商业模式灵活性

```
支持的定价模式：
┌─────────────────────────────────────────────────────────────┐
│  1. 统一订阅：三个产品共用等级（$9/$29/$99 月付）           │
│     - 订阅即解锁所有产品对应等级功能                        │
│     - 每月获得订阅积分，跨产品使用                          │
│                                                             │
│  2. 积分加油包：按需购买（$10/$30/$100）                    │
│     - 积分永不过期，可在任意产品消费                        │
│                                                             │
│  3. 年付优惠：Starter $99/年、Pro $299/年                   │
│     - 相当于免 1-2 个月费用                                 │
│                                                             │
│  4. 免费层：注册即送少量积分体验                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 实施方案

### 2.1 核心业务流程

#### 流程一：用户注册与初始化

```
┌─────────┐     ┌──────────────────┐     ┌─────────────────┐
│  用户   │────▶│   任意产品       │────▶│   统一身份平台   │
│         │     │  （入口点）      │     │                 │
└─────────┘     └──────────────────┘     └─────────────────┘
                         │                        │
                         │  跳转到                │
                         │  /auth/signup          │
                         ▼                        ▼
                ┌──────────────────┐     ┌─────────────────┐
                │  统一登录页面    │────▶│  自动创建：      │
                │  （单点登录）    │     │  - 用户记录      │
                └──────────────────┘     │  - 钱包（余额0） │
                                         │  - 免费订阅      │
                                         └─────────────────┘
                                                  │
                         ┌────────────────────────┘
                         ▼
                ┌──────────────────┐
                │  跳转回原产品     │
                │  携带认证 Token   │
                └──────────────────┘
```

**关键点**：

1. 用户从任意产品入口注册，都会跳转到统一的登录/注册页面
2. 注册成功后自动创建钱包（余额为0）和免费订阅
3. 携带认证 Token 跳转回原产品，实现无缝登录

#### 流程二：跨产品单点登录

```
场景：用户已登录 Fetchx，访问 Memox

┌─────────┐     ┌─────────┐     ┌──────────────────┐
│ Fetchx  │     │  Memox  │     │   统一身份平台    │
│(已登录) │     │(未登录) │     │                  │
└─────────┘     └─────────┘     └──────────────────┘
     │               │                    │
     │   用户点击    │                    │
     │   Memox 链接  │                    │
     │──────────────▶│                    │
     │               │  检查会话          │
     │               │───────────────────▶│
     │               │                    │
     │               │  会话有效          │
     │               │◀───────────────────│
     │               │                    │
     │               │  创建本地          │
     │               │  会话 Token        │
     │               │                    │
     │   已登录      │                    │
     │◀──────────────│                    │
```

**会话策略**：

- **共享 Cookie**（同域名）：`*.yourdomain.com` 共享 session cookie
- **Token 交换**（跨域名）：产品 A 的 token 换取产品 B 的 session

#### 流程三：积分购买与消费

```
购买流程：
┌─────────┐     ┌──────────────────┐     ┌─────────────────┐
│  用户   │────▶│   支付页面       │────▶│  支付提供商      │
│         │     │  （统一入口）    │     │  (Creem/Stripe) │
└─────────┘     └──────────────────┘     └─────────────────┘
                         │                        │
                         │                        │ Webhook 回调
                         │                        ▼
                         │               ┌─────────────────┐
                         │               │  统一身份平台    │
                         │               │  钱包.积分      │
                         │               │  += 购买数量    │
                         │               └─────────────────┘

消费流程：
┌─────────┐     ┌─────────┐     ┌──────────────────┐
│  用户   │────▶│  产品   │────▶│   统一身份平台    │
│         │     │(Fetchx) │     │                  │
└─────────┘     └─────────┘     └──────────────────┘
                    │                    │
                    │  扣减积分请求       │
                    │  (产品: fetchx,    │
                    │   数量: 10,        │
                    │   原因: 网页抓取)   │
                    │───────────────────▶│
                    │                    │
                    │  返回结果:         │
                    │  { 成功: true,     │
                    │    剩余: 990 }     │
                    │◀───────────────────│
                    │                    │
                    │  继续执行操作       │
```

**积分扣减规则**：

1. **预扣减**：操作前先扣减积分
2. **失败退还**：操作失败自动退还
3. **扣减优先级**：免费积分 → 订阅积分 → 购买积分
4. **审计追踪**：每笔交易记录产品、操作、数量

#### 流程四：订阅管理

```
┌─────────────────────────────────────────────────────────────┐
│                     统一订阅等级                             │
│  （三个产品共用，包含积分 + 全产品功能解锁）                 │
├─────────────────────────────────────────────────────────────┤
│  Starter 入门版                                              │
│  - 月付：$9/月                                              │
│  - 年付：$99/年（省 $9，相当于免 1 个月）                   │
│  - 积分：1,000 积分/月                                      │
│  - 权益：三个产品基础功能                                   │
├─────────────────────────────────────────────────────────────┤
│  Pro 专业版                                                  │
│  - 月付：$29/月                                             │
│  - 年付：$299/年（省 $49，相当于免 2 个月）                 │
│  - 积分：5,000 积分/月                                      │
│  - 权益：三个产品高级功能 + 优先支持                        │
├─────────────────────────────────────────────────────────────┤
│  Max 旗舰版                                                  │
│  - 月付：$99/月（仅支持月付）                               │
│  - 积分：20,000 积分/月                                     │
│  - 权益：三个产品全部功能 + 优先队列 + 专属支持             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     积分加油包                               │
│  （按需购买，永不过期，可在任意产品使用）                    │
├─────────────────────────────────────────────────────────────┤
│  小包：$10  →  1,000 积分                                   │
│  中包：$30  →  3,000 积分                                   │
│  大包：$100 →  10,000 积分                                  │
└─────────────────────────────────────────────────────────────┘
```

**权益检查流程**：

```
产品请求：
┌─────────┐     ┌─────────┐     ┌──────────────────┐
│  用户   │────▶│  产品   │────▶│   统一身份平台    │
└─────────┘     └─────────┘     └──────────────────┘
                    │                    │
                    │  检查权益          │
                    │  (产品: fetchx,    │
                    │   功能: pro)       │
                    │───────────────────▶│
                    │                    │
                    │  返回结果:         │
                    │  { 有权限: true,   │
                    │    等级: "pro",    │
                    │    到期: ... }     │
                    │◀───────────────────│
```

#### 流程五：资源查询（仪表盘）

```
用户仪表盘请求：
┌─────────┐     ┌──────────────────┐     ┌─────────────────┐
│  用户   │────▶│   控制台应用     │────▶│  统一身份平台    │
│         │     │  （统一入口）    │     │                 │
└─────────┘     └──────────────────┘     └─────────────────┘
                         │                        │
                         │  GET /api/v1/me        │
                         │───────────────────────▶│
                         │                        │
                         │  返回数据:             │
                         │  {                     │
                         │    用户: {...},        │
                         │    钱包: {             │
                         │      总余额: 5000,     │
                         │      免费积分: 100,    │
                         │      订阅积分: 3000,   │
                         │      购买积分: 1900    │
                         │    },                  │
                         │    订阅列表: [...],    │
                         │    权益列表: [...]     │
                         │  }                     │
                         │◀───────────────────────│
```

### 2.2 关键数据结构设计

#### 核心身份表

```
┌─────────────────────────────────────────────────────────────┐
│                         用户表 (User)                        │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  email         : string (唯一，有索引)                      │
│  name          : string? (可选)                             │
│  emailVerified : boolean (是否已验证邮箱)                   │
│  image         : string? (头像URL)                          │
│  isAdmin       : boolean (是否管理员)                       │
│  createdAt     : datetime (创建时间)                        │
│  updatedAt     : datetime (更新时间)                        │
│  deletedAt     : datetime? (软删除时间)                     │
├─────────────────────────────────────────────────────────────┤
│  关联关系:                                                   │
│  - sessions     : Session[] (会话列表)                      │
│  - accounts     : Account[] (OAuth 账号)                    │
│  - profile      : UserProfile (用户资料)                    │
│  - wallet       : Wallet (钱包)                             │
│  - subscriptions: Subscription[] (订阅列表)                 │
│  - entitlements : ProductEntitlement[] (权益列表)           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     用户资料表 (UserProfile)                 │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  userId        : string (外键，唯一)                        │
│  displayName   : string? (显示名称)                         │
│  avatarUrl     : string? (头像URL)                          │
│  timezone      : string? (时区)                             │
│  locale        : string? (语言偏好)                         │
│  metadata      : json? (扩展字段)                           │
└─────────────────────────────────────────────────────────────┘
```

#### 钱包与交易表

```
┌─────────────────────────────────────────────────────────────┐
│                        钱包表 (Wallet)                       │
├─────────────────────────────────────────────────────────────┤
│  id                  : cuid (主键)                          │
│  userId              : string (外键，唯一)                  │
│  ──────────────── 积分余额 ────────────────                 │
│  freeCredits         : int (免费积分，每月重置)             │
│  subscriptionCredits : int (订阅积分，来自有效订阅)         │
│  purchasedCredits    : int (购买积分，按量付费)             │
│  ──────────────── 周期追踪 ────────────────                 │
│  periodStartAt       : datetime (当前周期开始)              │
│  periodEndAt         : datetime (当前周期结束)              │
│  ──────────────── 计算字段 ────────────────                 │
│  totalBalance        : int (计算值：所有积分之和)           │
│  createdAt           : datetime                             │
│  updatedAt           : datetime                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  钱包交易表 (WalletTransaction)              │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  walletId      : string (外键)                              │
│  ──────────────── 交易信息 ────────────────                 │
│  type          : enum (充值/扣减/退款/重置)                 │
│                  CREDIT / DEBIT / REFUND / RESET            │
│  source        : enum (来源：免费/订阅/购买)                │
│                  FREE / SUBSCRIPTION / PURCHASED            │
│  amount        : int (正数为充值，负数为扣减)               │
│  balanceAfter  : int (交易后余额)                           │
│  ──────────────── 上下文 ────────────────                   │
│  product       : string? (产品：moryflow/fetchx/memox/sandx)│
│  operation     : string? (操作：scrape/memory_store 等)     │
│  referenceId   : string? (关联ID：job_id/order_id 等)       │
│  description   : string? (描述)                             │
│  ──────────────── 元数据 ────────────────                   │
│  metadata      : json? (扩展数据)                           │
│  createdAt     : datetime                                   │
│  ──────────────── 索引 ────────────────                     │
│  索引: (walletId, createdAt)                                │
│  索引: (product, createdAt)                                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    购买订单表 (PurchaseOrder)                │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  userId        : string (外键)                              │
│  walletId      : string (外键)                              │
│  ──────────────── 订单信息 ────────────────                 │
│  type          : enum (积分购买/订阅)                       │
│                  CREDITS / SUBSCRIPTION                     │
│  status        : enum (待支付/已完成/失败/已退款)           │
│                  PENDING / COMPLETED / FAILED / REFUNDED    │
│  amount        : decimal (金额，美元)                       │
│  credits       : int? (如果是积分购买，购买的积分数)        │
│  ──────────────── 支付提供商 ────────────────               │
│  provider      : enum (CREEM / STRIPE)                      │
│  externalId    : string (提供商的订单ID)                    │
│  externalData  : json? (提供商返回数据)                     │
│  ──────────────── 时间戳 ────────────────                   │
│  createdAt     : datetime                                   │
│  completedAt   : datetime?                                  │
└─────────────────────────────────────────────────────────────┘
```

#### 订阅与权益表

```
┌─────────────────────────────────────────────────────────────┐
│                      订阅表 (Subscription)                   │
├─────────────────────────────────────────────────────────────┤
│  id                     : cuid (主键)                       │
│  userId                 : string (外键)                     │
│  ──────────────── 套餐信息 ────────────────                 │
│  planId                 : string (外键，关联订阅套餐)       │
│  tier                   : enum (等级)                       │
│                          FREE / STARTER / PRO / MAX         │
│  status                 : enum (状态)                       │
│                          ACTIVE / CANCELED / PAST_DUE /     │
│                          EXPIRED / TRIALING                 │
│  ──────────────── 计费周期 ────────────────                 │
│  currentPeriodStart     : datetime (当前周期开始)           │
│  currentPeriodEnd       : datetime (当前周期结束)           │
│  cancelAtPeriodEnd      : boolean (周期结束时是否取消)      │
│  ──────────────── 积分分配 ────────────────                 │
│  creditsPerPeriod       : int (每周期包含的积分)            │
│  creditsUsedThisPeriod  : int (本周期已使用的积分)          │
│  ──────────────── 支付提供商 ────────────────               │
│  provider               : enum (CREEM / STRIPE)             │
│  externalCustomerId     : string? (提供商客户ID)            │
│  externalSubscriptionId : string? (提供商订阅ID)            │
│  ──────────────── 时间戳 ────────────────                   │
│  createdAt              : datetime                          │
│  updatedAt              : datetime                          │
│  canceledAt             : datetime?                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  产品权益表 (ProductEntitlement)             │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  userId        : string (外键)                              │
│  subscriptionId: string? (外键，如果来自订阅)               │
│  ──────────────── 权益信息 ────────────────                 │
│  product       : enum (产品)                                │
│                  FLOWX / FETCHX / MEMOX / SANDX / PLATFORM │
│  feature       : string (功能：pro/enterprise/具体功能名)   │
│  tier          : string? (产品特定的等级)                   │
│  ──────────────── 有效期 ────────────────                   │
│  isActive      : boolean (是否有效)                         │
│  grantedAt     : datetime (授权时间)                        │
│  expiresAt     : datetime? (过期时间)                       │
│  ──────────────── 来源 ────────────────                     │
│  source        : enum (来源)                                │
│                  SUBSCRIPTION / LICENSE / MANUAL / TRIAL    │
│  sourceId      : string? (来源ID：license_id/优惠码等)      │
│  ──────────────── 索引 ────────────────                     │
│  唯一索引: (userId, product, feature)                       │
│  索引: (userId, isActive)                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       许可证表 (License)                     │
├─────────────────────────────────────────────────────────────┤
│  id             : cuid (主键)                               │
│  userId         : string? (外键，未激活时为空)              │
│  ──────────────── 许可证信息 ────────────────               │
│  licenseKey     : string (唯一，有索引)                     │
│  product        : enum (产品)                               │
│                   FLOWX / FETCHX / MEMOX / SANDX / BUNDLE │
│  tier           : string (等级：standard/pro/enterprise)    │
│  ──────────────── 有效期 ────────────────                   │
│  status         : enum (状态)                               │
│                   ACTIVE / REVOKED / EXPIRED / PENDING      │
│  maxActivations : int (最大激活次数，默认1)                 │
│  activationCount: int (已激活次数，默认0)                   │
│  expiresAt      : datetime? (过期时间)                      │
│  ──────────────── 元数据 ────────────────                   │
│  metadata       : json? (客户名称、订单号等)                │
│  createdAt      : datetime                                  │
│  activatedAt    : datetime?                                 │
└─────────────────────────────────────────────────────────────┘
```

#### 配置表

```
┌─────────────────────────────────────────────────────────────┐
│                   订阅套餐表 (SubscriptionPlan)              │
├─────────────────────────────────────────────────────────────┤
│  id               : string (主键，如 "pro_monthly")         │
│  name             : string (显示名称)                       │
│  tier             : enum (等级)                             │
│                    FREE / STARTER / PRO / MAX               │
│  ──────────────── 定价 ────────────────                     │
│  priceMonthly     : decimal (月付价格，美元)                │
│  priceYearly      : decimal? (年付价格，null表示不支持年付) │
│  ──────────────── 积分 ────────────────                     │
│  creditsPerMonth  : int (每月积分)                          │
│  ──────────────── 功能 ────────────────                     │
│  features         : json (功能标志和限制)                   │
│  ──────────────── 元数据 ────────────────                   │
│  isActive         : boolean (是否可购买)                    │
│  sortOrder        : int (显示顺序)                          │
│  createdAt        : datetime                                │
│  updatedAt        : datetime                                │
└─────────────────────────────────────────────────────────────┘

套餐配置示例:
┌──────────────┬─────────┬─────────┬─────────┬──────────┐
│    套餐       │  FREE   │ STARTER │   PRO   │   MAX    │
├──────────────┼─────────┼─────────┼─────────┼──────────┤
│ 月付价格      │   $0    │   $9    │   $29   │   $99    │
│ 年付价格      │    -    │   $99   │  $299   │    -     │
│ 每月积分      │   100   │  1,000  │  5,000  │  20,000  │
│ 三产品解锁    │  基础   │  基础   │  高级   │   全部   │
└──────────────┴─────────┴─────────┴─────────┴──────────┘

FREE 层各产品权限边界:
┌──────────┬────────────────────────────────────────────┐
│  产品    │  FREE 层限制                                │
├──────────┼────────────────────────────────────────────┤
│ Moryflow    │ 最多发布 1 个网站；不能使用高级模型         │
│ (核心)   │ （笔记、工作流数量不限制）                  │
├──────────┼────────────────────────────────────────────┤
│ Fetchx   │ 最多 2 并发；其他功能不限制                 │
├──────────┼────────────────────────────────────────────┤
│ Memox    │ 最多 1,000 条记忆；最多 10 并发             │
├──────────┼────────────────────────────────────────────┤
│ Sandx    │ 最多 1 个沙盒实例                           │
└──────────┴────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   积分包表 (CreditPackage)                   │
├─────────────────────────────────────────────────────────────┤
│  id               : string (主键，如 "credits_small")       │
│  name             : string (显示名称)                       │
│  price            : decimal (价格，美元)                    │
│  credits          : int (获得的积分数)                      │
│  isActive         : boolean                                 │
│  sortOrder        : int                                     │
└─────────────────────────────────────────────────────────────┘

积分包配置:
┌──────────┬────────┬────────┐
│   名称   │  价格  │  积分  │
├──────────┼────────┼────────┤
│  小包    │  $10   │ 1,000  │
│  中包    │  $30   │ 3,000  │
│  大包    │  $100  │ 10,000 │
└──────────┴────────┴────────┘

features JSON 示例（全产品统一解锁）:
{
  "products": {
    "moryflow": { "enabled": true },
    "fetchx": { "enabled": true },
    "memox": { "enabled": true },
    "sandx": { "enabled": true }
  },
  "limits": {
    "concurrency": 10,
    "apiRequestsPerMinute": 100,
    "dataRetentionDays": 90
  }
}
```

#### 产品用量追踪

```
┌─────────────────────────────────────────────────────────────┐
│                  每日用量表 (ProductUsageDaily)              │
├─────────────────────────────────────────────────────────────┤
│  id               : cuid (主键)                             │
│  userId           : string (外键)                           │
│  product          : enum (产品：FLOWX/FETCHX/MEMOX/SANDX) │
│  date             : date (日期，有索引)                     │
│  ──────────────── 用量指标 ────────────────                 │
│  requestCount     : int (请求次数)                          │
│  creditsUsed      : int (消耗积分)                          │
│  ──────────────── 积分来源明细 ────────────────             │
│  creditsFree      : int (消耗的免费积分)                    │
│  creditsSub       : int (消耗的订阅积分)                    │
│  creditsPurchased : int (消耗的购买积分)                    │
│  ──────────────── 产品特定指标 ────────────────             │
│  metadata         : json? (产品特定的指标)                  │
│  ──────────────── 索引 ────────────────                     │
│  唯一索引: (userId, product, date)                          │
│  索引: (userId, date)                                       │
│  索引: (product, date)                                      │
└─────────────────────────────────────────────────────────────┘

Fetchx 的 metadata 示例:
{
  "pagesScraped": 1500,
  "bytesDownloaded": 52428800,
  "cacheHitRate": 0.35
}
```

### 2.3 API Key 设计

#### 混合方案

支持两种类型的 API Key，满足不同使用场景：

```
┌─────────────────────────────────────────────────────────────┐
│                      API Key 类型                            │
├─────────────────────────────────────────────────────────────┤
│  1. 平台级 Key（ag_）                                        │
│     - 由 Auth 服务统一颁发                                   │
│     - 可访问所有产品 API                                     │
│     - scope: ["moryflow", "fetchx", "memox", "sandx"]        │
│     - 适合：跨产品集成、自动化工作流                         │
│                                                             │
│  2. 产品级 Key（lx_ / fx_ / mx_ / sx_）                     │
│     - 由 Auth 服务统一颁发（数据集中管理）                   │
│     - 只能访问特定产品 API                                   │
│     - scope: ["moryflow"] 或 ["fetchx"] 或 ["sandx"] 等      │
│     - 适合：单产品用户、最小权限原则                         │
└─────────────────────────────────────────────────────────────┘
```

#### 前缀规则

| 前缀  | 产品范围                       | 使用场景       |
| ----- | ------------------------------ | -------------- |
| `ag_` | 全平台（Moryflow + 所有原子能力） | 跨产品集成     |
| `mf_` | 仅 Moryflow                       | 核心产品专用   |
| `fx_` | 仅 Fetchx                      | 网页抓取专用   |
| `mx_` | 仅 Memox                       | AI 记忆专用    |
| `sx_` | 仅 Sandx                       | Agent 沙盒专用 |

#### API Key 数据结构

```
┌─────────────────────────────────────────────────────────────┐
│                      API Key 表 (ApiKey)                    │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  userId        : string (外键)                              │
│  ──────────────── Key 信息 ────────────────                 │
│  keyHash       : string (SHA256 哈希，明文仅创建时显示一次) │
│  keyPrefix     : string (前 8 位，用于识别：ag_xxxx)        │
│  prefix        : enum (类型：AG / LX / FX / MX / SX)        │
│  name          : string (用户自定义名称)                    │
│  ──────────────── 权限范围 ────────────────                 │
│  scope         : string[] (如：["moryflow", "fetchx", "sandx"]) │
│  permissions   : json? (细粒度权限，可选)                   │
│  ──────────────── 状态 ────────────────                     │
│  isActive      : boolean (是否启用)                         │
│  lastUsedAt    : datetime? (最后使用时间)                   │
│  expiresAt     : datetime? (过期时间，null 表示永不过期)    │
│  ──────────────── 审计 ────────────────                     │
│  createdAt     : datetime                                   │
│  revokedAt     : datetime? (撤销时间)                       │
│  ──────────────── 索引 ────────────────                     │
│  索引: (keyHash) 唯一                                       │
│  索引: (userId, isActive)                                   │
└─────────────────────────────────────────────────────────────┘
```

#### 验证流程

```
请求到达：
┌─────────┐     ┌─────────────────┐     ┌──────────────────┐
│ 客户端  │────▶│   任意产品 API   │────▶│   Auth 服务      │
│         │     │                 │     │   验证 API Key   │
└─────────┘     └─────────────────┘     └──────────────────┘
                      │                         │
                      │  Header:                │
                      │  Authorization:         │
                      │  Bearer ag_xxxx...      │
                      │                         │
                      │                         ▼
                      │               ┌──────────────────┐
                      │               │  1. 查找 keyHash │
                      │               │  2. 检查 isActive│
                      │               │  3. 检查 scope   │
                      │               │  4. 检查 expires │
                      │               │  5. 更新 lastUsed│
                      │               └──────────────────┘
                      │                         │
                      │◀────────────────────────│
                      │  返回: userId, scope    │
```

---

### 2.4 API 网关设计

#### 接口结构

```
统一身份平台 API:
/api/v1/
├── auth/                    # 认证（Better Auth）
│   ├── signup               # 注册
│   ├── signin               # 登录
│   ├── signout              # 登出
│   ├── session              # 会话
│   └── ...
├── users/                   # 用户管理
│   ├── me                   # 当前用户资料
│   ├── me/profile           # 更新资料
│   └── me/delete            # 删除账号
├── wallet/                  # 积分管理
│   ├── balance              # 查询余额
│   ├── transactions         # 交易记录
│   ├── deduct               # 扣减积分（内部）
│   └── refund               # 退还积分（内部）
├── subscriptions/           # 订阅管理
│   ├── current              # 当前订阅
│   ├── plans                # 可用套餐
│   ├── checkout             # 开始订阅
│   └── cancel               # 取消订阅
├── entitlements/            # 产品权益
│   ├── check                # 检查权益
│   └── list                 # 列出所有权益
├── purchases/               # 积分购买
│   ├── packages             # 可用套餐
│   └── checkout             # 购买积分
└── admin/                   # 管理员接口
    ├── users/
    ├── wallets/
    └── subscriptions/
```

#### 服务间通信（公网域名调用）

**核心原则**：所有服务间调用都通过公网域名，确保每个产品完全独立、可单独部署。

```
产品通过公网域名调用统一身份平台 API：

示例：Fetchx 调用 Auth 服务扣减积分
POST https://auth.aiget.dev/v1/wallet/deduct
Authorization: Bearer {service_api_key}
{
  "userId": "user_xxx",
  "amount": 10,
  "product": "fetchx",
  "operation": "scrape",
  "referenceId": "job_yyy"
}
```

**架构优势**：

- 每个服务可独立部署到任意位置（不同云、不同区域）
- 无内网依赖，简化运维复杂度
- 天然支持多租户和白标部署
- 便于单产品独立售卖或迁移

> 注：暂不引入 gRPC 和消息队列，保持架构简洁。

### 2.4 迁移策略

#### 第一阶段：身份平台搭建

```
步骤 1：基础架构
├── 部署统一身份平台作为新服务
├── 创建数据库及新表结构
├── 实现核心认证接口
└── 配置 SSO Cookie/Token 共享

步骤 2：业务模块
├── 实现钱包服务
├── 实现订阅服务
├── 对接支付提供商
└── 搭建管理后台
```

#### 第二阶段：产品接入

> **试点选择**：Moryflow 作为第一个接入的产品，因为：
>
> 1. 核心产品，优先验证平台稳定性
> 2. 目前独立运行，未耦合其他应用
> 3. 干净的接入环境，便于发现问题

```
Moryflow 接入（试点）:
├── 将认证模块替换为身份平台客户端
├── 迁移现有用户到身份平台
├── 迁移积分到统一钱包
├── 验证 SSO 和积分扣减流程
└── 完善接入文档和最佳实践

Fetchx 接入:
├── 复用 Moryflow 接入经验
├── 迁移现有用户（可能与 Moryflow 用户合并）
├── 将配额系统替换为钱包 API 调用
└── 验证跨产品单点登录

Memox 接入:
├── 同 Fetchx 的接入步骤
└── 验证跨产品积分共享
```

#### 数据迁移方案

```
用户迁移:
1. 从产品 A 导出用户数据
2. 导入到身份平台（生成新 ID 或保留旧 ID）
3. 创建 ID 映射表
4. 更新产品 A 使用新用户 ID

配额/积分迁移:
1. 快照所有现有余额
2. 在身份平台创建钱包记录
3. 充入初始余额
4. 切换产品使用钱包 API
5. 验证余额一致

订阅迁移:
1. 导出有效订阅
2. 映射产品等级到平台等级
3. 创建订阅 + 权益记录
4. 验证功能访问不变
```

---

## 3. 部署架构

### 3.1 推荐基础设施

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            负载均衡器                                    │
│                       (Cloudflare / AWS ALB)                            │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
         ┌──────────────────────────┼──────────────────────────┐
         ▼                          ▼                          ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│  统一身份平台   │      │  Moryflow (核心)   │      │     Console     │
│ auth.aiget.dev  │      │ moryflow.aiget.dev │      │console.aiget.dev│
│                 │      │                 │      │                 │
│ - 认证服务      │      │ - 笔记工作流    │      │ - 用户控制台    │
│ - 钱包服务      │      │ - 网站发布      │      │ - 仪表盘        │
│ - 订阅服务      │      │ - Agent 调度    │      │                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
         │                        │                        │
         │            ┌───────────┼───────────┐            │
         │            ▼           ▼           ▼            │
         │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
         │   │   Fetchx    │ │   Memox     │ │   Sandx     │
         │   │ (原子能力)  │ │ (原子能力)  │ │ (原子能力)  │
         │   │             │ │             │ │             │
         │   │ - 网页抓取  │ │ - AI 记忆   │ │ - Agent沙盒 │
         │   │ - 浏览器池  │ │ - 向量数据库│ │ - 代码执行  │
         │   └─────────────┘ └─────────────┘ └─────────────┘
         │            │           │           │
         └────────────┴───────────┴───────────┘
                              │
                    ┌─────────────────┐
                    │   PostgreSQL    │
                    │  (共享或独立)    │
                    └─────────────────┘
```

### 3.2 数据库策略选项

| 方案            | 说明                          | 优点               | 缺点               |
| --------------- | ----------------------------- | ------------------ | ------------------ |
| **共享数据库**  | 所有服务使用同一个 PostgreSQL | 简单，易于跨表查询 | 耦合，扩展受限     |
| **Schema 隔离** | 同一数据库，不同 Schema       | 逻辑隔离           | 仍在数据库层面耦合 |
| **独立数据库**  | 每个服务独立数据库            | 真正隔离           | 跨服务查询困难     |

**建议**：先采用 **Schema 隔离**，待规模需要时再迁移到 **独立数据库**。

---

## 4. 安全考虑

### 4.1 Token 策略

```
Token 类型：
┌─────────────────────────────────────────────────────────────┐
│  1. 会话 Token（HTTP-only Cookie）                          │
│     - 用于 Web 应用                                         │
│     - 域名: .yourdomain.com（子域名共享）                   │
│     - 有效期: 7 天（活动时刷新）                            │
│                                                             │
│  2. Bearer Token（Authorization 头）                        │
│     - 用于移动端/API 客户端                                 │
│     - 有效期: 30 天                                         │
│     - 刷新 Token: 90 天                                     │
│                                                             │
│  3. 服务 Token（内部）                                      │
│     - 用于服务间认证                                        │
│     - 短期有效，自动轮换                                    │
│     - IP 白名单 + mTLS                                      │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 服务间安全

```
产品 → 统一身份平台：
1. 服务 API Key（每月轮换）
2. 请求签名（HMAC）
3. IP 白名单
4. 按服务限流
5. 所有请求审计日志
```

---

## 5. 总结

### 架构选择理由

| 考虑因素 | 决策                           |
| -------- | ------------------------------ |
| 用户体验 | 一个账号，无缝跨产品访问       |
| 开发体验 | 只需维护一套认证/支付集成      |
| 商业灵活 | 积分模式支持交叉销售和套餐捆绑 |
| 技术扩展 | 身份层独立扩展                 |
| 安全     | 集中式安全控制和审计           |

### 关键成功指标

- **用户转化率**：使用 2 个以上产品的用户占比
- **积分利用率**：跨产品积分使用率
- **支持效率**：用户身份问题减少量
- **开发速度**：新产品上线时间缩短

### 下一步行动

1. 评审并批准架构设计
2. 创建统一身份平台代码仓库
3. 实现核心服务（认证、钱包、订阅）
4. **Moryflow 试点接入**（核心产品，目前独立无耦合）
5. Fetchx / Memox 逐步接入

---

## 6. Monorepo 合并可行性评估

### 6.1 现状分析

#### 三个仓库结构对比

```
┌─────────────────────────────────────────────────────────────┐
│                    Fetchx（原 AIGET）                        │
├─────────────────────────────────────────────────────────────┤
│  apps/                                                       │
│  ├── server      NestJS 后端 (网页抓取引擎)                  │
│  ├── console     用户控制台 (React + Vite)                   │
│  ├── admin       管理后台 (React + Vite)                     │
│  ├── www         落地页 (TanStack Start)                     │
│  └── docs        文档站 (TanStack Start + Fumadocs)          │
│  packages/                                                   │
│  ├── ui          UI 组件库 (shadcn/ui)                       │
│  ├── types       共享类型（原 shared-types）                  │
│  ├── embed       嵌入脚本                                    │
│  └── embed-react React 嵌入组件                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                        Memox                                 │
├─────────────────────────────────────────────────────────────┤
│  apps/                                                       │
│  ├── server      NestJS 后端 (AI 记忆服务)                   │
│  ├── console     用户控制台                                  │
│  ├── admin       管理后台                                    │
│  ├── www         落地页                                      │
│  └── docs        文档站                                      │
│  packages/                                                   │
│  ├── ui          UI 组件库 (与 Fetchx 几乎相同)              │
│  └── types       共享类型（原 shared-types）                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       Moryflow                               │
├─────────────────────────────────────────────────────────────┤
│  apps/                                                       │
│  ├── server      NestJS 后端 (工作流引擎)                    │
│  ├── admin       管理后台                                    │
│  ├── www         落地页                                      │
│  ├── mobile      移动端 (React Native)                       │
│  ├── pc          桌面端                                      │
│  └── docs        文档站                                      │
│  packages/                                                   │
│  ├── ui          UI 组件库 (更丰富，含 AI 组件)              │
│  ├── agents-*    Agent 相关包 (10+ 个)                       │
│  ├── api/sync    共享包（原 shared-api/shared-sync）          │
│  └── tiptap      富文本编辑器                                │
└─────────────────────────────────────────────────────────────┘
```

#### 技术栈重合度

| 技术层   | Fetchx              | Memox               | Moryflow               | 重合度 |
| -------- | ------------------- | ------------------- | ------------------- | ------ |
| 包管理器 | pnpm workspace      | pnpm workspace      | pnpm workspace      | 100%   |
| 后端框架 | NestJS 11           | NestJS 11           | NestJS 11           | 100%   |
| 数据库   | Prisma + PostgreSQL | Prisma + PostgreSQL | Prisma + PostgreSQL | 100%   |
| 认证     | Better Auth         | Better Auth         | Better Auth         | 100%   |
| 队列     | BullMQ + Redis      | BullMQ + Redis      | BullMQ + Redis      | 100%   |
| 支付     | Creem               | Creem               | Creem               | 100%   |
| 前端框架 | React 19            | React 19            | React 19            | 100%   |
| 样式     | TailwindCSS v4      | TailwindCSS v4      | TailwindCSS v4      | 100%   |
| UI 组件  | shadcn/ui (Radix)   | shadcn/ui (Radix)   | shadcn/ui (Radix)   | ~90%   |
| 类型校验 | Zod                 | Zod                 | Zod                 | 100%   |
| 邮件     | Resend              | Resend              | Resend              | 100%   |
| 日志     | Pino                | Pino                | Pino                | 100%   |

#### 共享依赖分析

```
完全相同的依赖（三个项目都有）:
├── @nestjs/* (common, core, config, swagger, throttler, bullmq, schedule)
├── @prisma/client, @prisma/adapter-pg
├── better-auth
├── bullmq, ioredis
├── creem_io
├── resend
├── zod
├── pino, nestjs-pino
├── bcryptjs
├── express
└── rxjs

Fetchx 特有:
├── playwright (浏览器自动化)
├── sharp (图片处理)
├── turndown (HTML→Markdown)
├── jsdom (DOM 解析)
└── @mozilla/readability (正文提取)

Moryflow 特有:
├── @ai-sdk/* (anthropic, openai, google)
├── ai (Vercel AI SDK)
├── agents-* 包 (自研 Agent 框架)
├── @xyflow/react (流程图)
└── motion (动画)
```

### 6.2 可行性评估

#### 结论：✅ 高度可行

三个项目的技术栈高度统一，合并为 Monorepo 不仅可行，而且**强烈推荐**。

#### 合并收益

| 收益             | 说明                                         |
| ---------------- | -------------------------------------------- |
| **依赖去重**     | node_modules 大小可减少 40-60%，安装速度提升 |
| **UI 组件统一**  | Fetchx 和 Memox 的 UI 包几乎相同，可直接合并 |
| **共享模块复用** | auth、payment、quota 等核心模块只需维护一份  |
| **类型安全**     | 跨产品类型共享，编译时发现问题               |
| **原子变更**     | 跨产品重构可在一个 PR 内完成                 |
| **CI/CD 简化**   | 统一的构建和部署流程                         |
| **开发体验**     | 一个仓库，一个 IDE 窗口，统一的开发环境      |

#### 风险与挑战

| 风险         | 缓解措施                                 |
| ------------ | ---------------------------------------- |
| 仓库体积增大 | 使用 Git LFS 管理大文件，配置 .gitignore |
| CI 时间增长  | 使用 Turborepo 增量构建，只构建变更的包  |
| 权限管理复杂 | 使用 CODEOWNERS 按目录分配审核权限       |
| 迁移工作量   | 分阶段迁移，先合并共享包，再合并应用     |

### 6.3 推荐的 Monorepo 结构

```
Aiget/                               # Monorepo 根目录
├── apps/
│   ├── console/                     # 统一用户控制台 ⭐
│   │   └── src/
│   │       ├── modules/
│   │       │   ├── dashboard/       # 统一仪表盘
│   │       │   ├── fetchx/          # Fetchx 功能模块
│   │       │   ├── memox/           # Memox 功能模块
│   │       │   ├── moryflow/           # Moryflow 功能模块
│   │       │   ├── wallet/          # 钱包管理
│   │       │   ├── subscription/    # 订阅管理
│   │       │   ├── api-keys/        # API Key 管理
│   │       │   └── settings/        # 账户设置
│   │       └── ...
│   ├── admin/                       # 统一管理后台 ⭐
│   │   └── src/
│   │       ├── modules/
│   │       │   ├── users/           # 用户管理
│   │       │   ├── subscriptions/   # 订阅管理
│   │       │   ├── wallets/         # 钱包管理
│   │       │   ├── products/        # 各产品运营数据
│   │       │   └── system/          # 系统配置
│   │       └── ...
│   ├── fetchx/                      # Fetchx 产品
│   │   ├── server/                  # 网页抓取服务后端
│   │   └── www/                     # 落地页
│   ├── memox/                       # Memox 产品
│   │   ├── server/                  # AI 记忆服务后端
│   │   └── www/                     # 落地页
│   ├── moryflow/                       # Moryflow 产品
│   │   ├── server/                  # 工作流服务后端
│   │   ├── mobile/                  # 移动端（Expo）
│   │   ├── pc/                      # 桌面端（Electron）
│   │   └── www/                     # 落地页
│   └── docs/                        # 统一文档站
├── packages/
│   ├── ui/                          # 统一 UI 组件库
│   ├── types/                       # 跨产品共享类型
│   ├── api/                         # API 客户端
│   ├── auth/                        # 身份认证客户端
│   ├── config/                      # 共享配置
│   ├── agents-core/                 # Agent 核心（来自 moryflow）
│   ├── agents-*/                    # Agent 相关包
│   └── scraper-core/                # 抓取核心（来自 fetchx）
├── tooling/
│   ├── eslint-config/               # ESLint 配置
│   ├── typescript-config/           # TypeScript 配置
│   └── tailwind-config/             # Tailwind 配置
├── deploy/                          # 部署配置目录
│   ├── templates/                   # 模板文件
│   │   ├── Dockerfile.node         # Node.js 应用模板
│   │   ├── Dockerfile.static       # 静态站点模板
│   │   ├── docker-compose.base.yml # 基础 compose 模板
│   │   └── nginx.conf.template     # Nginx 配置模板
│   ├── console/                     # 统一控制台部署
│   │   ├── Dockerfile
│   │   ├── docker-compose.yml
│   │   └── .env.example
│   ├── admin/                       # 统一管理后台部署
│   │   ├── Dockerfile
│   │   ├── docker-compose.yml
│   │   └── .env.example
│   ├── fetchx/                      # Fetchx 服务部署
│   │   ├── Dockerfile
│   │   ├── docker-compose.yml
│   │   └── .env.example
│   ├── memox/                       # Memox 服务部署
│   │   ├── Dockerfile
│   │   ├── docker-compose.yml
│   │   └── .env.example
│   ├── moryflow/                       # Moryflow 服务部署
│   │   ├── Dockerfile
│   │   ├── docker-compose.yml
│   │   └── .env.example
│   ├── docs/                        # Docs 站点部署
│   │   ├── Dockerfile
│   │   └── docker-compose.yml
│   ├── infra/                       # 基础设施服务
│   │   ├── docker-compose.yml      # PostgreSQL, Redis, etc.
│   │   └── init-scripts/
│   ├── docker-compose.all.yml      # 全量部署（开发环境）
│   └── README.md                    # 部署文档
├── turbo.json                       # Turborepo 配置
├── pnpm-workspace.yaml
└── package.json
```

### 6.4 迁移步骤概要

> 详细的迁移检查清单见第 8 节「迁移执行计划」

#### 第一阶段：准备工作

```
1. 创建 Monorepo 结构（pnpm workspace + Turborepo）
2. 设置统一的工具配置（ESLint、TypeScript、Tailwind）
3. 配置 CI/CD (GitHub Actions)
```

#### 第二阶段：合并共享包

```
1. 合并三个 UI 包为统一的 @aiget/ui
2. 创建 @aiget/types（合并三个 types 包）
3. 迁移 Moryflow 的 agents-* 包
```

#### 第三阶段：迁移产品应用

```
1. 迁移 Moryflow（核心产品优先，目前独立无耦合）
   - 移动 apps/server → apps/moryflow/server
   - 移动 apps/mobile → apps/moryflow/mobile
   - 移动 apps/pc → apps/moryflow/pc

2. 迁移 Fetchx / Memox（复用 Moryflow 接入经验）
```

#### 第四阶段：创建统一服务

```
1. 创建 Auth Server（从 Fetchx 提取 auth、user 模块）
2. 创建统一 Console（合并各产品 Console 功能）
3. 创建统一 Admin（合并各产品 Admin 功能）
```

#### 第五阶段：集成与测试

```
1. 各产品接入身份平台
2. 端到端测试
3. 性能测试
4. 文档更新
```

### 6.5 Turborepo 配置示例

```json
// turbo.json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", "build/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "typecheck": {},
    "test": {
      "dependsOn": ["build"]
    },
    "lint": {}
  },
  "ui": "tui"
}
```

```yaml
# pnpm-workspace.yaml
packages:
  - 'apps/*'
  - 'apps/*/server'
  - 'apps/*/console'
  - 'apps/*/www'
  - 'packages/*'
  - 'tooling/*'
```

### 6.6 部署架构设计

#### 设计目标

支持**多机分布式部署**，每个服务可独立部署到不同机器，避免单机负载过重。

#### 目录结构说明

```
deploy/
├── templates/                   # 模板文件（复用基础）
│   ├── Dockerfile.node         # Node.js 后端服务模板
│   ├── Dockerfile.static       # 静态站点（React/Vite）模板
│   ├── docker-compose.base.yml # 基础 compose 配置
│   └── nginx.conf.template     # Nginx 反向代理模板
├── console/                     # 统一用户控制台 ⭐
│   ├── Dockerfile
│   ├── docker-compose.yml
│   ├── nginx.conf
│   └── .env.example
├── admin/                       # 统一管理后台 ⭐
│   ├── Dockerfile
│   ├── docker-compose.yml
│   └── .env.example
├── fetchx/                      # Fetchx 抓取服务
│   ├── Dockerfile.server       # 后端
│   ├── Dockerfile.www          # 落地页
│   ├── docker-compose.yml
│   ├── nginx.conf
│   └── .env.example
├── memox/                       # Memox 记忆服务
│   ├── Dockerfile.server       # 后端
│   ├── Dockerfile.www          # 落地页
│   ├── docker-compose.yml
│   ├── nginx.conf
│   └── .env.example
├── moryflow/                       # Moryflow 工作流服务
│   ├── Dockerfile.server       # 后端
│   ├── Dockerfile.www          # 落地页
│   ├── docker-compose.yml
│   ├── nginx.conf
│   └── .env.example
├── docs/                        # 统一文档站
│   ├── Dockerfile
│   └── docker-compose.yml
├── infra/                       # 基础设施服务
│   ├── docker-compose.yml      # PostgreSQL, Redis, etc.
│   └── init-scripts/
└── docker-compose.all.yml      # 全量部署（仅开发环境）
```

#### Docker 文件规范

**Dockerfile 模板规范：**

```dockerfile
# deploy/templates/Dockerfile.node
FROM node:22-alpine AS base
RUN corepack enable && corepack prepare pnpm@latest --activate

FROM base AS deps
WORKDIR /app
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY apps/${SERVICE_NAME}/package.json ./apps/${SERVICE_NAME}/
COPY packages/*/package.json ./packages/
RUN pnpm install --frozen-lockfile --prod

FROM base AS builder
WORKDIR /app
COPY . .
RUN pnpm install --frozen-lockfile
RUN pnpm --filter @aiget/${SERVICE_NAME} build

FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production
COPY --from=deps /app/node_modules ./node_modules
COPY --from=builder /app/apps/${SERVICE_NAME}/dist ./dist
EXPOSE 3000
CMD ["node", "dist/main.js"]
```

**子服务完整 docker-compose.yml 规范：**

每个子服务的 `docker-compose.yml` 必须包含该服务的**全部组件**，支持独立部署：

```yaml
# deploy/fetchx/docker-compose.yml
# Fetchx 完整服务栈 - 可独立部署到单台机器

services:
  # ============ 基础设施 ============
  postgres:
    image: postgres:16-alpine
    container_name: fetchx-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-fetchx}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME:-fetchx}
    volumes:
      - fetchx-postgres-data:/var/lib/postgresql/data
    networks:
      - fetchx-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER:-fetchx}']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: fetchx-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - fetchx-redis-data:/data
    networks:
      - fetchx-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ 后端服务 ============
  server:
    build:
      context: ../..
      dockerfile: deploy/fetchx/Dockerfile.server
    container_name: fetchx-server
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://${DB_USER:-fetchx}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-fetchx}
      REDIS_URL: redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fetchx-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ 前端服务 ============
  console:
    build:
      context: ../..
      dockerfile: deploy/fetchx/Dockerfile.console
    container_name: fetchx-console
    restart: unless-stopped
    networks:
      - fetchx-network

  www:
    build:
      context: ../..
      dockerfile: deploy/fetchx/Dockerfile.www
    container_name: fetchx-www
    restart: unless-stopped
    networks:
      - fetchx-network

  # ============ 网关/反向代理 ============
  nginx:
    image: nginx:alpine
    container_name: fetchx-nginx
    restart: unless-stopped
    ports:
      - '${HTTP_PORT:-80}:80'
      - '${HTTPS_PORT:-443}:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - server
      - console
      - www
    networks:
      - fetchx-network

volumes:
  fetchx-postgres-data:
  fetchx-redis-data:

networks:
  fetchx-network:
    driver: bridge
```

**Nginx 配置示例：**

```nginx
# deploy/fetchx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream server {
        server server:3000;
    }
    upstream console {
        server console:80;
    }
    upstream www {
        server www:80;
    }

    # Fetchx 落地页 - fetchx.aiget.dev
    server {
        listen 80;
        server_name fetchx.aiget.dev;
        location / {
            proxy_pass http://www;
        }
    }

    # Fetchx API - api.fetchx.aiget.dev
    server {
        listen 80;
        server_name api.fetchx.aiget.dev;
        location / {
            proxy_pass http://server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
```

**各子服务包含的组件：**

| 子服务      | 组件                                           | 域名                                   |
| ----------- | ---------------------------------------------- | -------------------------------------- |
| **console** | postgres、redis、server、nginx                 | console.aiget.dev                      |
| **admin**   | server、nginx                                  | admin.aiget.dev                        |
| **fetchx**  | postgres、redis、server、www、nginx            | fetchx.aiget.dev, api.fetchx.aiget.dev |
| **memox**   | postgres(+pgvector)、redis、server、www、nginx | memox.aiget.dev, api.memox.aiget.dev   |
| **moryflow**   | postgres、redis、server、www、nginx            | moryflow.aiget.dev, api.moryflow.aiget.dev   |
| **docs**    | static-site、nginx                             | docs.aiget.dev                         |

> **注意**：Console 和 Admin 现在是统一的，不再按产品分散。所有产品共享一个 Console（用户控制台）和一个 Admin（管理后台）。

#### 部署模式

| 模式         | 说明                         | 使用场景           |
| ------------ | ---------------------------- | ------------------ |
| **单机全量** | `docker-compose.all.yml`     | 开发环境、测试环境 |
| **单机分离** | 各服务独立 compose，同一机器 | 小规模生产         |
| **多机分布** | 各服务部署到不同机器         | 大规模生产         |

#### 多机部署示例

```
机器 A（认证服务）:
├── Auth Server
├── PostgreSQL (用户数据)
└── Redis (会话缓存)

机器 B（Fetchx 服务）:
├── Fetchx Server
├── Playwright 浏览器池
└── Redis (任务队列)

机器 C（Memox 服务）:
├── Memox Server
├── PostgreSQL (向量数据 + pgvector)
└── Redis (缓存)

机器 D（Moryflow 服务）:
├── Moryflow Server
├── PostgreSQL (工作流数据)
└── Redis (任务队列)

机器 E（前端 + 网关）:
├── Nginx (反向代理)
├── Admin Console
├── Docs Site
└── 各产品前端
```

#### 服务间通信（公网域名调用）

**核心原则**：所有服务间调用都通过公网域名，确保每个产品完全独立、可单独部署。

```yaml
# 各服务通过公网域名互相调用（非内网地址）
AUTH_API_URL=https://auth.aiget.dev
FLOWX_API_URL=https://api.moryflow.aiget.dev
FETCHX_API_URL=https://api.fetchx.aiget.dev
MEMOX_API_URL=https://api.memox.aiget.dev
SANDX_API_URL=https://api.sandx.aiget.dev
```

**架构优势**：

- 每个服务可独立部署到任意位置（不同云、不同区域）
- 无内网依赖，简化运维复杂度
- 天然支持多租户和白标部署
- 便于单产品独立售卖或迁移

### 6.7 命名规范建议

| 类型     | 命名模式                 | 示例                         |
| -------- | ------------------------ | ---------------------------- |
| 应用包   | `@aiget/{product}-{app}` | `@aiget/fetchx-server`       |
| 共享包   | `@aiget/{name}`          | `@aiget/types`、`@aiget/api` |
| UI 包    | `@aiget/ui`              | 唯一                         |
| 工具包   | `@aiget/{name}-config`   | `@aiget/eslint-config`       |
| Agent 包 | `@aiget/agents-{name}`   | `@aiget/agents-core`         |

---

## 7. 源仓库地址

以下是需要迁移到 Monorepo 的三个源仓库的绝对路径：

| 产品              | 绝对路径                          | 说明                                 |
| ----------------- | --------------------------------- | ------------------------------------ |
| Fetchx (原 AIGET) | `/Users/zhangbaolin/code/me/fetchx`   | 网页抓取与数据提取平台（仓库已更名） |
| Memox (原 MEMAI)  | `/Users/zhangbaolin/code/me/memai`    | AI 记忆与知识图谱服务                |
| Moryflow          | `/Users/zhangbaolin/code/me/moryflow` | 笔记 AI 工作流 + 网站发布（核心产品）|

### 各仓库主要目录结构

```
/Users/zhangbaolin/code/me/fetchx/    # 原 aiget，仓库已更名
├── apps/
│   ├── server/         # NestJS 后端（网页抓取核心）
│   ├── console/        # 用户控制台
│   ├── admin/          # 管理后台
│   ├── www/            # 落地页
│   └── docs/           # 文档站
├── packages/
│   ├── ui/             # UI 组件库
│   ├── shared-types/   # 共享类型（迁移后改为 types）
│   ├── embed/          # 嵌入脚本
│   └── embed-react/    # React 嵌入组件
└── docs/               # 技术文档

/Users/zhangbaolin/code/me/memai/    # 原 MEMAI，迁移后更名为 Memox
├── apps/
│   ├── server/         # NestJS 后端（AI 记忆核心）
│   ├── console/        # 用户控制台
│   ├── admin/          # 管理后台
│   ├── www/            # 落地页
│   └── docs/           # 文档站
├── packages/
│   ├── ui/             # UI 组件库
│   └── shared-types/   # 共享类型（迁移后改为 types）
└── docs/               # 技术文档

/Users/zhangbaolin/code/me/moryflow/    # Moryflow 核心产品（保持原名）
├── apps/
│   ├── server/         # NestJS 后端（工作流核心）
│   ├── admin/          # 管理后台
│   ├── mobile/         # 移动端（Expo）
│   ├── pc/             # 桌面端（Electron）
│   └── site-template/  # 站点模板
├── packages/
│   ├── ui/             # UI 组件库（最完整）
│   ├── agents-core/    # Agent 核心框架
│   ├── agents-openai/  # OpenAI Agent 实现
│   ├── shared-api/     # API 客户端（迁移后改为 api）
│   ├── shared-sync/    # 同步模块（迁移后改为 sync）
│   └── tiptap/         # 富文本编辑器
└── docs/               # 技术文档
```

---

## 8. 迁移执行计划

> 说明：每完成一步，将该项标记为 `[x]` 完成状态，并记录完成日期。

### 第一阶段：Monorepo 基础设施 ✅ (2026-01-05)

- [x] **1.1 初始化 Monorepo 结构** (2026-01-05)
  - [x] 创建 `pnpm-workspace.yaml` 配置
  - [x] 创建 `turbo.json` Turborepo 配置
  - [x] 创建根目录 `package.json`
  - [x] 配置 `.gitignore` 和 `.npmrc`

- [x] **1.2 创建工具配置包** (2026-01-05)
  - [x] `tooling/eslint-config/` - 统一 ESLint 配置（base, nestjs, react 三套配置）
  - [x] `tooling/typescript-config/` - 统一 TypeScript 配置（base, nestjs, react, react-native）
  - [x] `tooling/tailwind-config/` - 统一 Tailwind 配置（含 shadcn/ui 主题变量）

- [x] **1.3 配置 CI/CD** (2026-01-05)
  - [x] GitHub Actions 工作流（ci.yml，部署由 Dokploy 管理）
  - [x] 增量构建配置（Turborepo cache）
  - [x] 测试自动化（lint → typecheck → test → build 流水线）

### 第二阶段：合并共享包

- [x] **2.1 合并 UI 组件库** (2026-01-05)
  - [x] 以 Fetchx 的 `packages/ui/` 为基础（primitives/composed 结构更清晰）
  - [x] 统一导出为 `@aiget/ui`
  - [ ] Moryflow AI/animate/icons 组件待第三阶段迁移时添加

- [x] **2.2 创建统一共享类型包** (2026-01-05)
  - [x] 创建 `packages/types/` 包含 common/ 和 products/ 目录
  - [x] 定义跨产品通用类型（User, Wallet, Subscription, Product）
  - [x] 导出为 `@aiget/types`

- [x] **2.3 迁移 Moryflow 的 Agent 包** (2026-01-05)
  - [x] `packages/agents-core/` → `packages/agents-core/`
  - [x] `packages/agents-openai/` → `packages/agents-openai/`
  - [x] 更新包名为 `@aiget/agents-*`

- [x] **2.4 创建共享配置包** (2026-01-05)
  - [x] `packages/config/` - 环境变量验证
  - [x] `packages/api/` - API 客户端工具
  - [x] `packages/auth/` - 认证客户端（占位）

### 第三阶段：迁移 Moryflow 应用（核心产品优先）

> **为什么先迁移 Moryflow**：核心产品，目前独立运行未耦合其他应用，干净的接入环境便于验证平台。

- [x] **3.1 迁移 Moryflow Server**
  - [x] 移动 `apps/server/` → `apps/moryflow/server/`
  - [x] 更新 package.json 名称为 `@aiget/moryflow-server`
  - [x] 更新 import 路径
  - [ ] 验证 typecheck 通过
  - [ ] 验证测试通过

- [x] **3.2 迁移 Moryflow Mobile**
  - [x] 移动 `apps/mobile/` → `apps/moryflow/mobile/`
  - [x] 更新 package.json 名称
  - [x] 更新 import 路径
  - [ ] 验证 Expo 构建通过

- [x] **3.3 迁移 Moryflow PC**
  - [x] 移动 `apps/pc/` → `apps/moryflow/pc/`
  - [x] 更新 package.json 名称
  - [x] 更新 Electron 配置
  - [ ] 验证构建通过

- [x] **3.4 迁移 Moryflow 站点模板**
  - [x] 迁移 `apps/site-template/` → `apps/moryflow/site-template/`
  - [x] 更新 package.json 名称

- [x] **3.5 迁移 Moryflow 特有包**
  - [x] 迁移 `packages/tiptap/` → `packages/tiptap/`
  - [ ] 迁移 `packages/shared-api/` → `packages/api/`（合并到统一 api 包，待后续处理）
  - [x] 迁移 `packages/shared-sync/` → `packages/sync/`
  - [x] 更新 package.json 名称
  - [ ] 验证构建通过

### 第四阶段：迁移 Fetchx 应用

- [ ] **4.1 迁移 Fetchx Server**
  - [ ] 移动 `apps/server/` → `apps/fetchx/server/`
  - [ ] 更新 package.json 名称为 `@aiget/fetchx-server`
  - [ ] 更新 import 路径（UI, shared-types）
  - [ ] 验证 typecheck 通过
  - [ ] 验证测试通过

- [ ] **4.2 迁移 Fetchx WWW**
  - [ ] 移动 `apps/www/` → `apps/fetchx/www/`
  - [ ] 更新 package.json 名称
  - [ ] 更新 import 路径
  - [ ] 验证构建通过

- [ ] **4.3 提取 Fetchx 核心模块**
  - [ ] 从 server 提取 scraper 核心 → `packages/scraper-core/`
  - [ ] 更新依赖关系

- [ ] **4.4 迁移 Fetchx 嵌入包**
  - [ ] 迁移 `packages/embed/` → `packages/embed/`
  - [ ] 迁移 `packages/embed-react/` → `packages/embed-react/`
  - [ ] 更新 package.json 名称为 `@aiget/embed` 和 `@aiget/embed-react`
  - [ ] 验证构建通过

### 第五阶段：迁移 Memox 应用

- [ ] **5.1 迁移 Memox Server**
  - [ ] 移动 `apps/server/` → `apps/memox/server/`
  - [ ] 更新 package.json 名称为 `@aiget/memox-server`
  - [ ] 更新 import 路径
  - [ ] 验证 typecheck 通过
  - [ ] 验证测试通过

- [ ] **5.2 迁移 Memox WWW**
  - [ ] 移动 `apps/www/` → `apps/memox/www/`
  - [ ] 更新 package.json 名称
  - [ ] 更新 import 路径
  - [ ] 验证构建通过

- [ ] **5.3 提取 Memox 核心模块**
  - [ ] 从 server 提取 memory 核心 → `packages/memory-core/`
  - [ ] 提取 embedding 模块 → `packages/embedding/`
  - [ ] 更新依赖关系

### 第六阶段：创建统一认证服务

- [ ] **6.1 创建 Auth Server**
  - [ ] 创建 `apps/auth/server/` 目录结构
  - [ ] 从 Fetchx 提取 auth 模块
  - [ ] 从 Fetchx 提取 user 模块
  - [ ] 实现 Wallet 钱包模块
  - [ ] 实现 Subscription 订阅模块
  - [ ] 实现 Entitlement 权益模块
  - [ ] 配置数据库 Schema
  - [ ] 对接支付提供商（Creem）

- [ ] **6.2 创建统一用户控制台**
  - [ ] 创建 `apps/console/` 目录结构
  - [ ] 合并各产品 Console 的功能模块
  - [ ] 实现统一仪表盘
  - [ ] 实现钱包管理页面
  - [ ] 实现订阅管理页面
  - [ ] 实现 API Key 管理
  - [ ] 实现跨产品功能切换

- [ ] **6.3 产品接入认证服务**
  - [ ] Fetchx 接入 Auth API
  - [ ] Memox 接入 Auth API
  - [ ] Moryflow 接入 Auth API
  - [ ] 测试单点登录（SSO）
  - [ ] 测试跨产品积分共享

### 第七阶段：合并管理后台与文档站

- [ ] **7.1 创建统一管理后台**
  - [ ] 创建 `apps/admin/` 目录结构
  - [ ] 合并三个产品的 Admin 功能
  - [ ] 实现跨产品用户管理
  - [ ] 实现统一钱包管理
  - [ ] 实现统一订阅管理

- [ ] **7.2 创建统一文档站**
  - [ ] 创建 `apps/docs/` 目录结构
  - [ ] 合并三个产品的文档
  - [ ] 配置统一的 Fumadocs 结构
  - [ ] 实现产品切换导航

### 第八阶段：集成测试与部署

- [ ] **8.1 端到端测试**
  - [ ] 统一身份流程测试
  - [ ] 跨产品积分流程测试
  - [ ] SSO 流程测试
  - [ ] 支付流程测试

- [ ] **8.2 性能测试**
  - [ ] 构建时间基准测试
  - [ ] Turborepo 缓存效果验证
  - [ ] 各产品 API 性能测试

- [ ] **8.3 部署配置**
  - [ ] 更新 Docker 配置
  - [ ] 更新 CI/CD 部署流程
  - [ ] 配置各环境变量
  - [ ] 配置域名与负载均衡

- [ ] **8.4 文档完善**
  - [ ] 更新所有 CLAUDE.md 文件
  - [ ] 更新 README.md
  - [ ] 编写迁移总结

---

## 9. 迁移日志

> 每次完成迁移步骤后，在此记录进度。

| 日期       | 阶段     | 完成内容                                                                                                                                     | 执行者 |
| ---------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 2026-01-04 | 准备     | 创建新仓库，编写 CLAUDE.md 和架构文档                                                                                                        | Claude |
| 2026-01-05 | 第一阶段 | 初始化 Monorepo 基础设施（pnpm-workspace、turbo.json、工具配置包、CI/CD）                                                                    | Claude |
| 2026-01-05 | 第二阶段 | 合并共享包（@aiget/ui、@aiget/types、@aiget/agents-\*、@aiget/config、@aiget/api、@aiget/auth）                                              | Claude |
| 2026-01-05 | 第三阶段 | 迁移 Moryflow 应用（server、mobile、pc、site-template）→ apps/moryflow/\*，迁移 @aiget/tiptap、@aiget/sync 包，更新所有 @moryflow 引用为 @aiget | Claude |

---

_文档版本: 1.3_
_创建日期: 2026-01-04_
_最后更新: 2026-01-05_
_作者: Claude (AI 助手)_
