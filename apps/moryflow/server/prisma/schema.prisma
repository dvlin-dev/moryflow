// Prisma Schema for Moryflow Membership
// 基于原 Drizzle Schema 转换

generator client {
  provider   = "prisma-client"
  output     = "../generated/prisma"
  outputType = "commonjs"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// Enums
// ==========================================

enum SubscriptionTier {
  free
  starter
  basic
  pro
  license
}

enum SubscriptionStatus {
  active
  canceled
  expired
  unpaid
  trialing
  paused
}

enum PaymentStatus {
  pending
  completed
  refunded
  failed
}

enum ProductType {
  subscription
  credits
  license
}

enum LicenseStatus {
  active
  revoked
}

enum LicenseTier {
  standard
  pro
}

enum LicenseActivationStatus {
  active
  deactivated
}

// ==========================================
// Better Auth 核心表
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified Boolean   @default(false)
  image         String?
  isAdmin       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // 软删除时间戳，null 表示未删除

  sessions            Session[]
  refreshTokens       RefreshToken[]
  accounts            Account[]
  profile             UserProfile?
  subscriptionCredits SubscriptionCredits?
  purchasedCredits    PurchasedCredits[]
  subscription        Subscription?
  paymentOrders       PaymentOrder[]
  licenses            License[]
  activityLogs        ActivityLog[]        @relation("UserActivityLogs")
  targetActivityLogs  ActivityLog[]        @relation("TargetActivityLogs")
  creditDebt          CreditDebt?

  // 云同步相关
  vaults              Vault[]
  vectorizedFiles     VectorizedFile[]
  storageUsage        UserStorageUsage?

  // 站点发布
  sites               Site[]

  // 账户删除记录
  deletionRecord      AccountDeletionRecord?

  // Agent 日志
  agentTraces         AgentTrace[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RefreshToken {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedBy RefreshToken? @relation("RefreshTokenRotation", fields: [replacedById], references: [id])
  replacements RefreshToken[] @relation("RefreshTokenRotation")

  @@index([userId])
}

model Jwks {
  id         String   @id @default(cuid())
  publicKey  String
  privateKey String
  createdAt  DateTime @default(now())
  expiresAt  DateTime?
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// ==========================================
// 用户扩展表
// ==========================================

model UserProfile {
  userId      String   @id
  displayName String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==========================================
// 积分相关表
// ==========================================

model SubscriptionCredits {
  userId           String   @id
  creditsRemaining Int      @default(0)
  creditsTotal     Int      @default(0)
  periodStart      DateTime
  periodEnd        DateTime
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PurchasedCredits {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  remaining   Int
  orderId     String?
  purchasedAt DateTime @default(now())
  expiresAt   DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model CreditUsageDaily {
  userId                  String
  date                    String // YYYY-MM-DD
  creditsUsedDaily        Int    @default(0)
  creditsUsedSubscription Int    @default(0)
  creditsUsedPurchased    Int    @default(0)
  requestCount            Int    @default(0)
  tokenUsed               Int    @default(0)

  @@id([userId, date])
  @@index([date])
}

model CreditDebt {
  userId    String   @id
  amount    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==========================================
// 订阅与支付表
// ==========================================

model Subscription {
  id                  String             @id @default(cuid())
  userId              String             @unique
  tier                SubscriptionTier   @default(free)
  status              SubscriptionStatus @default(active)
  creemSubscriptionId String?            @unique
  creemCustomerId     String?
  productId           String?
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model PaymentOrder {
  id              String        @id @default(cuid())
  userId          String
  creemCheckoutId String        @unique
  creemOrderId    String?
  productId       String
  productType     ProductType
  amount          Int // 金额（美分）
  currency        String        @default("USD")
  status          PaymentStatus
  discountCode    String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  completedAt     DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([creemOrderId])
  @@index([userId])
  @@index([status])
  @@index([productType])
  @@index([createdAt])
}

// ==========================================
// License 表
// ==========================================

model License {
  id              String        @id @default(cuid())
  userId          String
  licenseKey      String        @unique
  orderId         String
  tier            LicenseTier
  status          LicenseStatus
  activationCount Int           @default(0)
  activationLimit Int
  createdAt       DateTime      @default(now())

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  activations LicenseActivation[]

  @@index([userId])
  @@index([status])
}

model LicenseActivation {
  id            String                  @id @default(cuid())
  licenseId     String
  instanceName  String
  instanceId    String
  status        LicenseActivationStatus
  activatedAt   DateTime                @default(now())
  deactivatedAt DateTime?

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@unique([licenseId, instanceId])
  @@index([licenseId])
  @@index([status])
}

// ==========================================
// 活动日志表（用户操作审计 + 业务行为追踪）
// ==========================================

model ActivityLog {
  id           String   @id @default(cuid())

  // 操作者
  userId       String              // 操作者用户 ID
  targetUserId String?             // 目标用户 ID（管理员操作时使用）

  // 分类和动作
  category     String              // 事件分类：auth / ai / payment / admin / vault / storage / sync
  action       String              // 具体动作：login / chat / grant_credits / ...
  level        String   @default("info")  // 日志级别：info / warn / error

  // 详情（限制 4KB）
  details      Json?               // 请求参数、响应摘要等

  // 上下文
  ip           String?
  userAgent    String?
  duration     Int?                // 耗时（毫秒）

  // 时间
  createdAt    DateTime @default(now())

  // 关联
  user         User     @relation("UserActivityLogs", fields: [userId], references: [id], onDelete: Cascade)
  targetUser   User?    @relation("TargetActivityLogs", fields: [targetUserId], references: [id], onDelete: SetNull)

  // 索引
  @@index([userId])
  @@index([targetUserId])
  @@index([category])
  @@index([action])
  @@index([level])
  @@index([createdAt])
  @@index([userId, createdAt])           // 用户时间线查询
  @@index([category, action, createdAt]) // 事件类型统计
}

// ==========================================
// 账户删除记录表
// ==========================================

/// 账户删除记录（用于统计分析和审计）
model AccountDeletionRecord {
  id        String   @id @default(cuid())
  userId    String   @unique
  email     String                        // 删除时的邮箱（保留用于记录）
  reason    String                        // 删除原因代码
  feedback  String?                       // 用户可选的详细反馈
  deletedAt DateTime @default(now())      // 删除时间

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reason])
  @@index([deletedAt])
}

// ==========================================
// AI Provider 和 Model 表
// ==========================================

model AiProvider {
  id           String   @id @default(cuid())
  providerType String // openai | anthropic | google | openrouter | oneapi
  name         String
  apiKey       String
  baseUrl      String?
  enabled      Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  models AiModel[]

  @@index([enabled])
  @@index([providerType])
}

model AiModel {
  id               String   @id @default(cuid())
  providerId       String
  modelId          String // 对外模型 ID（如 'gpt-4o-mini'）
  upstreamId       String // 上游模型 ID（调用 API 时使用）
  displayName      String
  enabled          Boolean  @default(true)
  inputTokenPrice  Float // 输入 token 价格（美元/1M）
  outputTokenPrice Float // 输出 token 价格（美元/1M）
  minTier          SubscriptionTier
  maxContextTokens Int
  maxOutputTokens  Int
  capabilitiesJson Json // 模型能力配置
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  provider AiProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, modelId])
  @@index([providerId])
  @@index([enabled])
  @@index([modelId])
}

// ==========================================
// 云同步相关表
// ==========================================

/// 用户的 Vault
model Vault {
  id        String   @id @default(uuid())
  userId    String
  name      String
  createdAt DateTime @default(now())

  files   SyncFile[]
  devices VaultDevice[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// 设备与 Vault 的关联（多设备同步）
model VaultDevice {
  id         String    @id @default(uuid())
  vaultId    String
  deviceId   String
  deviceName String
  lastSyncAt DateTime?

  vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@unique([vaultId, deviceId])
  @@index([vaultId])
}

/// 同步文件元数据
model SyncFile {
  id          String   @id
  vaultId     String
  path        String
  title       String
  size        Int
  contentHash String

  // 向量时钟（核心）
  vectorClock Json     @default("{}")

  // 软删除
  isDeleted   Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@unique([vaultId, path])
  @@index([vaultId, isDeleted])
}

// ==========================================
// 向量化记录表（独立于云同步）
// ==========================================

/// 向量化文件记录
model VectorizedFile {
  id           String   @id @default(uuid())
  userId       String
  fileId       String
  title        String
  vectorizedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fileId])
  @@index([userId])
}

// ==========================================
// 用量统计表
// ==========================================

/// 用户存储用量
model UserStorageUsage {
  id              String   @id @default(uuid())
  userId          String   @unique
  storageUsed     BigInt   @default(0)
  vectorizedCount Int      @default(0)
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==========================================
// 语音转录相关表
// ==========================================

enum TranscriptionStatus {
  pending    // 待转录
  processing // 转录中
  completed  // 完成
  failed     // 失败
}

/// 音频文件转录记录
model AudioFile {
  id       String @id @default(cuid())
  userId   String
  vaultId  String? // 可选关联的 Vault

  // 文件信息
  fileName String              // 原始文件名
  fileSize Int                 // 压缩后大小(bytes)
  duration Int      @default(0) // 时长(秒)
  mimeType String              // audio/flac, audio/mp4 等

  // R2 存储
  r2Key String @unique // R2 对象键

  // 转录结果
  status   TranscriptionStatus @default(pending)
  rawText  String? @db.Text    // Whisper 原始转录文本
  text     String? @db.Text    // LLM 优化后的文本
  errorMsg String?             // 错误信息

  // 元数据
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([vaultId])
  @@index([status])
}

// ==========================================
// 站点发布相关表
// ==========================================

enum SiteType {
  MARKDOWN  // Markdown 直渲站点
  GENERATED // AI 生成站点
}

enum SiteStatus {
  ACTIVE  // 正常
  OFFLINE // 已下线（可恢复）
}

/// 用户发布的站点
model Site {
  id          String     @id @default(cuid())
  userId      String
  subdomain   String     @unique // 子域名，如 john → john.moryflow.app
  type        SiteType
  status      SiteStatus @default(ACTIVE)

  // 站点配置
  title       String?
  description String?
  favicon     String?    // favicon 的 R2 路径

  // 会员功能
  showWatermark Boolean  @default(true) // 非付费用户强制显示水印

  // 时间戳
  publishedAt DateTime?  // 首次发布时间
  expiresAt   DateTime?  // 过期时间（免费用户 = publishedAt + 1年）
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // 关联
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  pages SitePage[]

  @@index([userId])
  @@index([status])
}

/// 站点页面
model SitePage {
  id     String  @id @default(cuid())
  siteId String
  path   String // 页面路径，如 /guide/setup
  title  String?

  // 关联本地文件（用于更新检测）
  localFilePath String? // vault 相对路径
  localFileHash String? // 用于检测变更

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, path])
  @@index([siteId])
}

// ==========================================
// Agent 日志表
// ==========================================

enum AgentTraceStatus {
  pending
  completed
  failed
  interrupted
}

enum AgentSpanStatus {
  pending
  success
  failed
  cancelled
}

/// Agent 执行追踪
model AgentTrace {
  id          String           @id @default(cuid())
  userId      String
  traceId     String           @unique // agents-core 的 trace_id
  groupId     String?                  // 多轮对话组 ID

  // Agent 信息
  agentName   String
  agentType   String?

  // 执行概要
  status      AgentTraceStatus @default(pending)
  turnCount   Int              @default(0)
  totalTokens Int              @default(0)
  duration    Int?             // 总耗时（毫秒）

  // 错误信息
  errorType    String?
  errorMessage String?         @db.Text

  // 元数据
  metadata    Json?

  // 时间
  startedAt   DateTime         @default(now())
  completedAt DateTime?

  // 关联
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  spans       AgentSpan[]

  @@index([userId])
  @@index([traceId])
  @@index([groupId])
  @@index([status])
  @@index([agentName])
  @@index([startedAt])
  @@index([userId, startedAt])
}

/// Agent Span 详情（Tool 执行、模型调用等）
model AgentSpan {
  id           String          @id @default(cuid())
  traceId      String          // 外键关联 AgentTrace.traceId

  // Span 标识
  spanId       String
  parentSpanId String?

  // 类型和名称
  type         String          // agent | function | generation | handoff | guardrail | custom
  name         String

  // 执行状态
  status       AgentSpanStatus @default(pending)

  // 输入输出（失败时必填）
  input        Json?
  output       Json?

  // 错误信息
  errorType    String?
  errorMessage String?         @db.Text
  errorStack   String?         @db.Text

  // 性能指标
  duration     Int?            // 耗时（毫秒）
  tokens       Int?            // Token 消耗

  // 时间
  startedAt    DateTime
  endedAt      DateTime?

  // 关联
  trace        AgentTrace      @relation(fields: [traceId], references: [traceId], onDelete: Cascade)

  @@index([traceId])
  @@index([spanId])
  @@index([parentSpanId])
  @@index([type])
  @@index([status])
  @@index([name, status])
  @@index([traceId, startedAt])
}

// ==========================================
// Agent 告警系统
// ==========================================

enum AlertRuleType {
  tool_failure_rate    // Tool 失败率
  agent_consecutive    // Agent 连续失败
  system_failure_rate  // 系统整体失败率
}

enum AlertLevel {
  warning
  critical
}

/// 告警规则
model AlertRule {
  id          String        @id @default(cuid())
  name        String        // 规则名称
  type        AlertRuleType // 规则类型
  level       AlertLevel    @default(warning)

  // 触发条件
  condition   Json          // { metric, operator, threshold, timeWindow, minCount? }

  // 通知配置
  actions     Json          // [{ channel: 'email', target: 'xxx@xx.com' }]

  // 冷却时间（秒），同一告警在此时间内不重复发送
  cooldown    Int           @default(3600)

  // 启用状态
  enabled     Boolean       @default(true)

  // 时间
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // 关联
  history     AlertHistory[]

  @@index([type])
  @@index([enabled])
}

/// 告警历史
model AlertHistory {
  id          String      @id @default(cuid())
  ruleId      String
  level       AlertLevel

  // 触发上下文
  context     Json        // { toolName?, agentName?, value, threshold, message }

  // 时间
  triggeredAt DateTime    @default(now())
  resolvedAt  DateTime?   // 告警恢复时间（可选）

  // 关联
  rule        AlertRule   @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([triggeredAt])
  @@index([level])
}
