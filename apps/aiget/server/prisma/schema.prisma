// Prisma Schema for Aiget
// 网页截图 API 服务

generator client {
  provider   = "prisma-client"
  output     = "../generated/prisma"
  outputType = "commonjs"
}

datasource db {
  provider = "postgresql"
}

// =============================================
// 用户系统（Better Auth 核心表）
// =============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified Boolean   @default(false)
  image         String?
  isAdmin       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // 软删除时间戳，null 表示未删除

  sessions              Session[]
  accounts              Account[]
  subscription          Subscription?
  quota                 Quota?
  apiKeys               ApiKey[]
  screenshots           Screenshot[]
  webhooks              Webhook[]
  accountDeletionRecord AccountDeletionRecord?
  scrapeJobs            ScrapeJob[]
  batchScrapeJobs       BatchScrapeJob[]
  crawlJobs             CrawlJob[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// =============================================
// 订阅系统
// =============================================

enum SubscriptionTier {
  FREE
  BASIC
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  EXPIRED
}

model Subscription {
  id                  String             @id @default(cuid())
  userId              String             @unique
  tier                SubscriptionTier   @default(FREE)
  status              SubscriptionStatus @default(ACTIVE)
  creemCustomerId     String?
  creemSubscriptionId String?            @unique
  currentPeriodStart  DateTime           @default(now())
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================
// 配额系统
// =============================================

enum QuotaTransactionType {
  DEDUCT    // 扣减
  REFUND    // 返还
  PURCHASE  // 购买
  RESET     // 周期重置
}

enum QuotaSource {
  MONTHLY    // 月度配额
  PURCHASED  // 购买配额
}

model Quota {
  id             String   @id @default(cuid())
  userId         String   @unique

  // 月度订阅配额
  monthlyLimit   Int      @default(100)
  monthlyUsed    Int      @default(0)
  periodStartAt  DateTime @default(now())
  periodEndAt    DateTime

  // 按量购买额度（永不过期）
  purchasedQuota Int      @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QuotaTransaction {
  id            String               @id @default(cuid())
  userId        String
  type          QuotaTransactionType
  amount        Int                  // 正数
  source        QuotaSource
  balanceBefore Int
  balanceAfter  Int
  reason        String?              // screenshot_id 或其他说明
  createdAt     DateTime             @default(now())

  @@index([userId])
  @@index([createdAt])
}

// =============================================
// 支付订单
// =============================================

model PaymentOrder {
  id           String   @id @default(cuid())
  userId       String
  creemOrderId String   @unique
  type         String   // subscription | quota_purchase
  amount       Int      // 金额（分）
  currency     String   @default("USD")
  status       String   // pending | completed | failed | refunded
  quotaAmount  Int?     // 购买的配额数量（按量购买时）
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

// =============================================
// API Key
// =============================================

model ApiKey {
  id         String    @id @default(cuid())
  userId     String
  name       String
  keyPrefix  String    // 展示用，如 "ag_abc1"
  keyHash    String    @unique // SHA256(完整key)
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  screenshots Screenshot[]
  scrapeJobs  ScrapeJob[]
  memories    Memory[]
  entities    Entity[]
  relations   Relation[]

  @@index([userId])
  @@index([keyHash])
}

// =============================================
// Memox - 语义记忆与知识图谱
// =============================================

model Memory {
  id        String   @id @default(cuid())
  apiKeyId  String

  // 调用方的用户 ID（非平台用户）
  userId    String
  agentId   String?
  sessionId String?

  content   String
  embedding Unsupported("vector(1536)")?
  metadata  Json?
  source    String?
  importance Float?  @default(0.5)
  tags      String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, userId])
  @@index([apiKeyId, userId, agentId])
  @@index([apiKeyId, createdAt])
}

model Entity {
  id         String   @id @default(cuid())
  apiKeyId   String
  userId     String
  type       String   @db.VarChar(100)
  name       String   @db.VarChar(500)
  properties Json?
  embedding  Unsupported("vector(1536)")?
  confidence Float?   @default(1.0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  apiKey          ApiKey     @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  sourceRelations Relation[] @relation("SourceEntity")
  targetRelations Relation[] @relation("TargetEntity")

  @@unique([apiKeyId, userId, type, name])
  @@index([apiKeyId, userId])
  @@index([apiKeyId, userId, type])
}

model Relation {
  id         String    @id @default(cuid())
  apiKeyId   String
  userId     String
  sourceId   String
  targetId   String
  type       String    @db.VarChar(100)
  properties Json?
  confidence Float?    @default(1.0)
  validFrom  DateTime?
  validTo    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  source Entity @relation("SourceEntity", fields: [sourceId], references: [id], onDelete: Cascade)
  target Entity @relation("TargetEntity", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, userId])
  @@index([sourceId])
  @@index([targetId])
  @@index([apiKeyId, userId, type])
}

// =============================================
// 截图记录
// =============================================

enum ScreenshotStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Screenshot {
  id          String           @id @default(cuid())
  userId      String
  apiKeyId    String?

  // 请求信息
  url         String
  requestHash String
  request     Json

  // 配额追踪
  quotaDeducted Boolean      @default(false)
  quotaSource   QuotaSource?

  // 处理结果
  status        ScreenshotStatus @default(PENDING)
  fileUrl       String?
  fileSize      Int?
  fileExpiresAt DateTime?
  error         String?

  // 页面元信息
  pageTitle   String?
  pageDesc    String?
  pageFavicon String?

  // 性能
  processingMs   Int?
  fromCache      Boolean        @default(false)

  // 时间统计（各阶段耗时）
  queueWaitMs    Int?           // 队列等待时间
  pageLoadMs     Int?           // 页面加载时间
  captureMs      Int?           // 截图捕获时间
  imageProcessMs Int?           // 图片处理时间
  uploadMs       Int?           // 文件上传时间

  // 时间
  createdAt   DateTime        @default(now())
  completedAt DateTime?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([url])
  @@index([requestHash])
  @@index([status])
  @@index([createdAt])
  @@index([fileExpiresAt])
}

// =============================================
// Webhook 配置
// =============================================

model Webhook {
  id        String   @id @default(cuid())
  userId    String
  name      String
  url       String
  secret    String
  events    String[] @default(["screenshot.completed", "screenshot.failed"])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([userId])
}

model WebhookDelivery {
  id          String    @id @default(cuid())
  webhookId   String
  event       String
  payload     Json
  statusCode  Int?
  response    String?
  error       String?
  attempts    Int       @default(1)
  success     Boolean   @default(false)
  latencyMs   Int?
  createdAt   DateTime  @default(now())
  deliveredAt DateTime?

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
}

// =============================================
// 账户删除记录
// =============================================

model AccountDeletionRecord {
  id        String   @id @default(cuid())
  userId    String   @unique
  email     String   // 删除时的邮箱（保留用于记录）
  reason    String   // 删除原因代码
  feedback  String?  // 用户可选的详细反馈
  deletedAt DateTime @default(now()) // 删除时间

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reason])
  @@index([deletedAt])
}

// =============================================
// Scrape API - 网页抓取
// =============================================

enum ScrapeStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ScrapeErrorCode {
  PAGE_TIMEOUT      // 页面加载超时
  URL_NOT_ALLOWED   // SSRF 防护拦截
  SELECTOR_NOT_FOUND // CSS 选择器未找到
  BROWSER_ERROR     // 浏览器错误
  NETWORK_ERROR     // 网络错误
  RATE_LIMITED      // 限流
  QUOTA_EXCEEDED    // 配额不足
  INVALID_URL       // URL 格式错误
  PAGE_NOT_FOUND    // 404
  ACCESS_DENIED     // 403
  STORAGE_ERROR     // 文件存储错误
}

model ScrapeJob {
  id          String         @id @default(cuid())
  userId      String
  apiKeyId    String?

  url         String
  requestHash String         // SHA256(url + options)
  status      ScrapeStatus   @default(PENDING)

  // 请求选项
  options     Json           // { formats, waitFor, timeout, viewport, screenshotOptions, ... }

  // 结果（根据 formats 动态填充）
  result      Json?          // { markdown?, html?, rawHtml?, links?, metadata }

  // 截图输出（独立存储，因为需要 R2 URL）
  screenshotUrl       String?
  screenshotBase64    String?
  screenshotWidth     Int?
  screenshotHeight    Int?
  screenshotFileSize  Int?
  screenshotFormat    String?      // 'png' | 'jpeg' | 'webp'
  screenshotExpiresAt DateTime?

  // PDF 输出（仅 URL，不支持 base64）
  pdfUrl              String?
  pdfFileSize         Int?
  pdfPageCount        Int?
  pdfExpiresAt        DateTime?

  // 错误信息
  error       String?
  errorCode   ScrapeErrorCode?

  // 性能指标
  queueWaitMs    Int?
  fetchMs        Int?
  renderMs       Int?
  transformMs    Int?
  screenshotMs   Int?
  pdfMs          Int?
  imageProcessMs Int?
  uploadMs       Int?
  totalMs        Int?

  // 缓存
  fromCache   Boolean        @default(false)

  // 配额
  quotaDeducted Boolean      @default(false)
  quotaSource   QuotaSource?
  quotaAmount   Int?
  quotaTransactionId String?
  billingKey    String?

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  completedAt DateTime?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([requestHash])
  @@index([status])
  @@index([url])
  @@index([createdAt])
}

// =============================================
// Batch Scrape - 批量抓取
// =============================================

enum BatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model BatchScrapeJob {
  id            String       @id @default(cuid())
  userId        String

  status        BatchStatus  @default(PENDING)
  totalUrls     Int
  completedUrls Int          @default(0)
  failedUrls    Int          @default(0)

  options       Json         // 通用抓取选项
  webhookUrl    String?      // 完成后回调 URL

  // 配额（每次创建任务扣 1，失败全退）
  quotaDeducted Boolean      @default(false)
  quotaSource   QuotaSource?
  quotaAmount   Int?
  quotaTransactionId String?
  billingKey    String?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  startedAt     DateTime?
  completedAt   DateTime?

  items         BatchScrapeItem[]
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model BatchScrapeItem {
  id          String       @id @default(cuid())
  batchJobId  String
  batchJob    BatchScrapeJob @relation(fields: [batchJobId], references: [id], onDelete: Cascade)

  url         String
  order       Int          // 保持顺序
  status      ScrapeStatus @default(PENDING)

  result      Json?
  error       String?
  errorCode   ScrapeErrorCode?

  createdAt   DateTime     @default(now())
  completedAt DateTime?

  @@index([batchJobId])
  @@index([status])
}

// =============================================
// Crawl API - 网站爬取
// =============================================

enum CrawlStatus {
  PENDING
  CRAWLING
  COMPLETED
  FAILED
  CANCELLED
}

model CrawlJob {
  id          String       @id @default(cuid())
  userId      String

  startUrl    String
  status      CrawlStatus  @default(PENDING)

  // 配置
  options     Json         // { maxDepth, limit, includePaths, excludePaths, ... }

  // 进度
  totalUrls      Int       @default(0)
  completedUrls  Int       @default(0)
  failedUrls     Int       @default(0)

  // Webhook
  webhookUrl  String?

  // 配额（每次创建任务扣 1，失败全退）
  quotaDeducted Boolean      @default(false)
  quotaSource   QuotaSource?
  quotaAmount   Int?
  quotaTransactionId String?
  billingKey    String?

  // 时间
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  pages       CrawlPage[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model CrawlPage {
  id          String       @id @default(cuid())
  crawlJobId  String
  crawlJob    CrawlJob     @relation(fields: [crawlJobId], references: [id], onDelete: Cascade)

  url         String
  depth       Int          // 距离起始 URL 的深度
  status      ScrapeStatus @default(PENDING)

  // 结果
  result      Json?        // { markdown, html, metadata, links, ... }
  error       String?

  createdAt   DateTime     @default(now())
  completedAt DateTime?

  @@index([crawlJobId])
  @@index([status])
  @@unique([crawlJobId, url])
}
