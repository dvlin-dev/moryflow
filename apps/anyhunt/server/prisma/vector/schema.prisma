// Prisma Schema for Anyhunt - Vector Database
// Memox 向量数据库（Memory、MemoxEntity）

generator client {
  provider        = "prisma-client"
  output          = "../../generated/prisma-vector"
  outputType      = "commonjs"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// =============================================
// Memox - 语义记忆（Mem0 对标）
// =============================================

model Memory {
  id        String   @id @default(uuid())
  apiKeyId  String   // 软引用（无外键约束）

  // 调用方的用户/实体维度
  userId    String?
  agentId   String?
  appId     String?
  runId     String?
  orgId     String?
  projectId String?

  memory    String
  input     Json?    // messages 原始输入
  metadata  Json?
  categories String[] @default([])
  keywords  String[] @default([])
  hash      String?
  immutable Boolean  @default(false)
  expirationDate DateTime?
  timestamp DateTime?
  entities  Json?
  relations Json?

  embedding Unsupported("vector(1536)")?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([apiKeyId, userId])
  @@index([apiKeyId, agentId])
  @@index([apiKeyId, appId])
  @@index([apiKeyId, runId])
  @@index([apiKeyId, orgId])
  @@index([apiKeyId, projectId])
  @@index([apiKeyId, createdAt])
}

// =============================================
// Memox - Memory History
// =============================================

model MemoryHistory {
  id        String   @id @default(uuid())
  apiKeyId  String
  memoryId  String
  userId    String
  input     Json?
  oldMemory String?
  newMemory String
  event     String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([apiKeyId, memoryId])
  @@index([apiKeyId, userId])
  @@index([apiKeyId, createdAt])
}

// =============================================
// Memox - Memory Feedback
// =============================================

model MemoryFeedback {
  id             String   @id @default(uuid())
  apiKeyId       String
  memoryId       String
  feedback       String?
  feedbackReason String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([apiKeyId, memoryId])
  @@index([apiKeyId, createdAt])
}

// =============================================
// Memox - Memory Export
// =============================================

model MemoryExport {
  id        String   @id @default(uuid())
  apiKeyId  String
  schema    Json
  filters   Json?
  orgId     String?
  projectId String?
  status    String
  r2Key     String?
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([apiKeyId, createdAt])
}

// =============================================
// Memox - Entities（Mem0 /v1/entities, /v1/users, /v1/agents, /v1/apps, /v1/runs）
// =============================================

model MemoxEntity {
  id        String   @id @default(uuid())
  apiKeyId  String
  type      String   // user | agent | app | run
  entityId  String
  name      String?
  metadata  Json?
  orgId     String?
  projectId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([apiKeyId, type, entityId])
  @@index([apiKeyId, type])
  @@index([apiKeyId, createdAt])
}
