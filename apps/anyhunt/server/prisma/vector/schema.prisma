// Prisma Schema for Anyhunt - Vector Database
// Memox 向量数据库（Memory、Entity、Relation）

generator client {
  provider        = "prisma-client"
  output          = "../../generated/prisma-vector"
  outputType      = "commonjs"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// =============================================
// Memox - 语义记忆
// =============================================

model Memory {
  id        String   @id @default(cuid())
  apiKeyId  String   // 软引用（无外键约束）

  // 调用方的用户 ID（非平台用户）
  userId    String
  agentId   String?
  sessionId String?

  content   String
  embedding Unsupported("vector(1536)")?
  metadata  Json?
  source    String?
  importance Float?  @default(0.5)
  tags      String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([apiKeyId, userId])
  @@index([apiKeyId, userId, agentId])
  @@index([apiKeyId, createdAt])
}

// =============================================
// Memox - 知识图谱实体
// =============================================

model Entity {
  id         String   @id @default(cuid())
  apiKeyId   String   // 软引用（无外键约束）
  userId     String
  type       String   @db.VarChar(100)
  name       String   @db.VarChar(500)
  properties Json?
  embedding  Unsupported("vector(1536)")?
  confidence Float?   @default(1.0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // 库内关系（保留）
  sourceRelations Relation[] @relation("SourceEntity")
  targetRelations Relation[] @relation("TargetEntity")

  @@unique([apiKeyId, userId, type, name])
  @@index([apiKeyId, userId])
  @@index([apiKeyId, userId, type])
}

// =============================================
// Memox - 知识图谱关系
// =============================================

model Relation {
  id         String    @id @default(cuid())
  apiKeyId   String    // 软引用（无外键约束）
  userId     String
  sourceId   String
  targetId   String
  type       String    @db.VarChar(100)
  properties Json?
  confidence Float?    @default(1.0)
  validFrom  DateTime?
  validTo    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // 库内关系（保留）
  source Entity @relation("SourceEntity", fields: [sourceId], references: [id], onDelete: Cascade)
  target Entity @relation("TargetEntity", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, userId])
  @@index([sourceId])
  @@index([targetId])
  @@index([apiKeyId, userId, type])
}
