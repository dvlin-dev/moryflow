const { readFileSync, writeFileSync } = require('node:fs');
const { resolve } = require('node:path');
const { cwd } = require('node:process');

const packageJson = JSON.parse(
  readFileSync(resolve(cwd(), 'package.json'), 'utf-8'),
);

const dependencies = Object.entries(packageJson.dependencies ?? {});
const moryflowDependencies = dependencies.filter(
  ([name]) => name.startsWith('@moryflow/') || name === 'openai',
);

const versions = {
  [packageJson.name]: packageJson.version,
  ...Object.fromEntries(
    moryflowDependencies.map(([name, version]) => [name, version]),
  ),
};

const METADATA = {
  name: packageJson.name,
  version: packageJson.version,
  versions,
};

const output = `
// This file is automatically generated

export const METADATA = ${JSON.stringify(METADATA, null, 2)};

export default METADATA;
`;

writeFileSync(resolve(cwd(), 'src/metadata.ts'), output, 'utf-8');
