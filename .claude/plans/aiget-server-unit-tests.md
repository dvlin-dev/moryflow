# Aiget Server å•å…ƒæµ‹è¯•è§„åˆ’

## ç›®æ ‡

ä¸º `apps/aiget/server/src` æ‰€æœ‰æ¨¡å—æ·»åŠ å®Œæ•´å•å…ƒæµ‹è¯•ï¼Œè¾¾åˆ° 80%+ è¦†ç›–ç‡ã€‚

## å½“å‰æµ‹è¯•çŠ¶æ€

### å·²æœ‰æµ‹è¯•çš„æ¨¡å—

| æ¨¡å—       | æµ‹è¯•æ–‡ä»¶æ•° | çŠ¶æ€    | è¯´æ˜            |
| ---------- | ---------- | ------- | --------------- |
| `digest/`  | 26         | âœ… å®Œæˆ | è¦†ç›–ç‡ 90%+     |
| `scraper/` | 6          | ğŸŸ¡ éƒ¨åˆ† | æ ¸å¿ƒæŠ“å–å¼•æ“    |
| `quota/`   | 4          | ğŸŸ¡ éƒ¨åˆ† | é…é¢ç®¡ç†        |
| `admin/`   | 1          | ğŸŸ¡ éƒ¨åˆ† | ç®¡ç†åå° API    |
| `api-key/` | 1          | ğŸŸ¡ éƒ¨åˆ† | API Key ç®¡ç†    |
| `auth/`    | 1          | ğŸŸ¡ éƒ¨åˆ† | è®¤è¯æ¨¡å—        |
| `common/`  | 1          | ğŸŸ¡ éƒ¨åˆ† | å…¬å…±å·¥å…·        |
| `crawler/` | 1          | ğŸŸ¡ éƒ¨åˆ† | å¤šé¡µçˆ¬å–        |
| `extract/` | 1          | ğŸŸ¡ éƒ¨åˆ† | AI æ•°æ®æå–     |
| `map/`     | 1          | ğŸŸ¡ éƒ¨åˆ† | URL å‘ç°        |
| `payment/` | 1          | ğŸŸ¡ éƒ¨åˆ† | æ”¯ä»˜å¤„ç†        |
| `webhook/` | 1          | ğŸŸ¡ éƒ¨åˆ† | Webhook é€šçŸ¥    |
| `redis/`   | 1          | ğŸŸ¡ éƒ¨åˆ† | Redis ç¼“å­˜      |
| `demo/`    | 1          | ğŸŸ¡ éƒ¨åˆ† | Playground æ¼”ç¤º |

### æ— æµ‹è¯•çš„æ¨¡å—

| æ¨¡å—                  | æ–‡ä»¶æ•° | ä¼˜å…ˆçº§ | è¯´æ˜                   |
| --------------------- | ------ | ------ | ---------------------- |
| `billing/`            | 5      | **P0** | è®¡è´¹æ ¸å¿ƒï¼Œå½±å“æ”¶å…¥     |
| `memory/`             | 7      | **P1** | Memox è¯­ä¹‰è®°å¿† API     |
| `entity/`             | 7      | **P1** | Memox çŸ¥è¯†å›¾è°±å®ä½“     |
| `relation/`           | 6      | **P1** | Memox çŸ¥è¯†å›¾è°±å…³ç³»     |
| `graph/`              | 4      | **P1** | Memox å›¾è°±éå†         |
| `embedding/`          | 3      | **P1** | Memox å‘é‡åµŒå…¥         |
| `search/`             | 5      | **P1** | ç½‘é¡µæœç´¢ API           |
| `batch-scrape/`       | 8      | **P1** | æ‰¹é‡æŠ“å–               |
| `oembed/`             | 8      | **P2** | oEmbed æä¾›å•†          |
| `storage/`            | 7      | **P2** | R2 äº‘å­˜å‚¨              |
| `user/`               | 5      | **P2** | ç”¨æˆ·ç®¡ç†               |
| `email/`              | 3      | **P2** | é‚®ä»¶æœåŠ¡               |
| `browser/`            | 5      | **P3** | æµè§ˆå™¨æ± ç®¡ç†           |
| `queue/`              | 4      | **P3** | BullMQ é˜Ÿåˆ—é…ç½®        |
| `health/`             | 3      | **P3** | å¥åº·æ£€æŸ¥               |
| `config/`             | 2      | **P3** | ä»·æ ¼é…ç½®               |
| `console-playground/` | 4      | **P3** | æ§åˆ¶å° Playground      |
| `prisma/`             | 3      | **P4** | ä¸»åº“è¿æ¥ï¼ˆåŸºç¡€è®¾æ–½ï¼‰   |
| `vector-prisma/`      | 3      | **P4** | å‘é‡åº“è¿æ¥ï¼ˆåŸºç¡€è®¾æ–½ï¼‰ |
| `not-found/`          | 2      | **P4** | 404 å¤„ç†               |
| `types/`              | 6      | **P4** | ç±»å‹å®šä¹‰ï¼ˆæ— é€»è¾‘ï¼‰     |

---

## æ‰§è¡Œè®¡åˆ’

### Phase 1: è®¡è´¹æ ¸å¿ƒ (P0)

**ç›®æ ‡**: billing æ¨¡å— 100% è¦†ç›–

| æ–‡ä»¶                   | æµ‹è¯•é‡ç‚¹                    |
| ---------------------- | --------------------------- |
| `billing.service.ts`   | æ‰£è´¹/é€€è´¹é€»è¾‘ã€è®¡è´¹è§„åˆ™åº”ç”¨ |
| `billing.rules.ts`     | å„ API è®¡è´¹è§„åˆ™éªŒè¯         |
| `billing.decorator.ts` | @BillingKey è£…é¥°å™¨          |

**é¢„è®¡**: 3 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œ~50 ä¸ªæµ‹è¯•ç”¨ä¾‹

---

### Phase 2: Memox æ¨¡å— (P1)

**ç›®æ ‡**: memory/entity/relation/graph/embedding è¦†ç›–ç‡ â‰¥80%

| æ¨¡å—         | æµ‹è¯•é‡ç‚¹             |
| ------------ | -------------------- |
| `memory/`    | CRUDã€è¯­ä¹‰æœç´¢ã€è¿‡æ»¤ |
| `entity/`    | å®ä½“åˆ›å»ºã€å…³è”ã€æŸ¥è¯¢ |
| `relation/`  | å…³ç³»å»ºç«‹ã€éå†       |
| `graph/`     | å›¾è°±æŸ¥è¯¢ã€è·¯å¾„æœç´¢   |
| `embedding/` | å‘é‡ç”Ÿæˆã€ç›¸ä¼¼åº¦è®¡ç®— |

**é¢„è®¡**: 15 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œ~200 ä¸ªæµ‹è¯•ç”¨ä¾‹

---

### Phase 3: Fetchx æ ¸å¿ƒ (P1)

**ç›®æ ‡**: search/batch-scrape è¦†ç›–ç‡ â‰¥80%

| æ¨¡å—            | æµ‹è¯•é‡ç‚¹                      |
| --------------- | ----------------------------- |
| `search/`       | æœç´¢ APIã€ç»“æœè§£æã€SSRF é˜²æŠ¤ |
| `batch-scrape/` | æ‰¹é‡å¤„ç†ã€å¹¶å‘æ§åˆ¶ã€é”™è¯¯æ¢å¤  |

**é¢„è®¡**: 6 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œ~80 ä¸ªæµ‹è¯•ç”¨ä¾‹

---

### Phase 4: è¾…åŠ©æœåŠ¡ (P2)

**ç›®æ ‡**: oembed/storage/user/email è¦†ç›–ç‡ â‰¥80%

| æ¨¡å—       | æµ‹è¯•é‡ç‚¹                 |
| ---------- | ------------------------ |
| `oembed/`  | å„æä¾›å•†è§£æã€ç¼“å­˜ç­–ç•¥   |
| `storage/` | R2 ä¸Šä¼ /ä¸‹è½½ã€é¢„ç­¾å URL |
| `user/`    | ç”¨æˆ· CRUDã€æƒé™éªŒè¯      |
| `email/`   | é‚®ä»¶å‘é€ã€æ¨¡æ¿æ¸²æŸ“       |

**é¢„è®¡**: 10 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œ~120 ä¸ªæµ‹è¯•ç”¨ä¾‹

---

### Phase 5: åŸºç¡€è®¾æ–½ (P3-P4)

**ç›®æ ‡**: å‰©ä½™æ¨¡å—åŸºç¡€è¦†ç›–

| æ¨¡å—       | æµ‹è¯•é‡ç‚¹         |
| ---------- | ---------------- |
| `browser/` | æµè§ˆå™¨æ± ç”Ÿå‘½å‘¨æœŸ |
| `queue/`   | é˜Ÿåˆ—é…ç½®éªŒè¯     |
| `health/`  | å¥åº·æ£€æŸ¥ç«¯ç‚¹     |
| `config/`  | é…ç½®åŠ è½½         |

**é¢„è®¡**: 6 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œ~40 ä¸ªæµ‹è¯•ç”¨ä¾‹

---

### Phase 6: è¡¥å……ç°æœ‰æµ‹è¯•

**ç›®æ ‡**: å·²æœ‰æµ‹è¯•æ¨¡å—è¾¾åˆ° â‰¥80% è¦†ç›–ç‡

| æ¨¡å—       | å½“å‰   | ç›®æ ‡ | è¡¥å……å†…å®¹         |
| ---------- | ------ | ---- | ---------------- |
| `scraper/` | 6 æ–‡ä»¶ | â‰¥80% | è½¬æ¢å™¨ã€é”™è¯¯å¤„ç† |
| `quota/`   | 4 æ–‡ä»¶ | â‰¥80% | è¾¹ç•Œæ¡ä»¶ã€å¹¶å‘   |
| `api-key/` | 1 æ–‡ä»¶ | â‰¥80% | å“ˆå¸ŒéªŒè¯ã€æƒé™   |
| `auth/`    | 1 æ–‡ä»¶ | â‰¥80% | OAuth æµç¨‹       |
| `common/`  | 1 æ–‡ä»¶ | â‰¥80% | Guardsã€Pipes    |
| `crawler/` | 1 æ–‡ä»¶ | â‰¥80% | æ·±åº¦æ§åˆ¶ã€å»é‡   |
| `extract/` | 1 æ–‡ä»¶ | â‰¥80% | Schema éªŒè¯      |
| `map/`     | 1 æ–‡ä»¶ | â‰¥80% | Sitemap è§£æ     |
| `payment/` | 1 æ–‡ä»¶ | â‰¥80% | Webhook éªŒç­¾     |
| `webhook/` | 1 æ–‡ä»¶ | â‰¥80% | é‡è¯•ç­–ç•¥         |

**é¢„è®¡**: 20+ ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œ~300 ä¸ªæµ‹è¯•ç”¨ä¾‹

---

## æµ‹è¯•æ¶æ„

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ module-name/
â”‚   â”œâ”€â”€ __tests__/
â”‚   â”‚   â”œâ”€â”€ mocks/           # æ¨¡å—ä¸“ç”¨ Mockï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ module.service.spec.ts
â”‚   â”‚   â”œâ”€â”€ module.controller.spec.ts
â”‚   â”‚   â””â”€â”€ module.utils.spec.ts
â”‚   â”œâ”€â”€ module.module.ts
â”‚   â”œâ”€â”€ module.service.ts
â”‚   â””â”€â”€ ...
```

### Mock å¤ç”¨

ä¼˜å…ˆå¤ç”¨ `digest/__tests__/mocks/` ä¸­çš„å·¥å‚ï¼š

- `createMockPrisma()` - Prisma Mock
- `createMockQueue()` - BullMQ Mock
- `createMockConfigService()` - é…ç½® Mock

å¦‚éœ€æ‰©å±•ï¼Œåœ¨å¯¹åº”æ¨¡å— `__tests__/mocks/` ä¸‹æ–°å»ºã€‚

---

## éªŒæ”¶æ ‡å‡†

| æŒ‡æ ‡           | ç›®æ ‡                            |
| -------------- | ------------------------------- |
| æ•´ä½“è¡Œè¦†ç›–ç‡   | â‰¥80%                            |
| æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡ | â‰¥90% (billing, memory, scraper) |
| æµ‹è¯•é€šè¿‡ç‡     | 100%                            |
| CI é›†æˆ        | âœ… æµ‹è¯•å¤±è´¥é˜»æ­¢åˆå¹¶             |

---

## æ‰§è¡Œé¡ºåºå»ºè®®

```
Phase 1 (billing)     â†’ 1-2 å¤©
Phase 2 (Memox)       â†’ 3-4 å¤©
Phase 3 (Fetchx)      â†’ 2 å¤©
Phase 4 (è¾…åŠ©æœåŠ¡)    â†’ 2-3 å¤©
Phase 5 (åŸºç¡€è®¾æ–½)    â†’ 1 å¤©
Phase 6 (è¡¥å……ç°æœ‰)    â†’ 3-4 å¤©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                  â†’ 12-16 å¤©
```

---

## ç›¸å…³æ–‡æ¡£

- Digest æµ‹è¯•è®¡åˆ’ï¼ˆå·²å®Œæˆï¼‰: `.claude/plans/breezy-petting-toucan.md`
- Vitest é…ç½®: `apps/aiget/server/vitest.config.ts`
- CI é…ç½®: `.github/workflows/ci.yml`

---

_åˆ›å»ºæ—¥æœŸ: 2026-01-14_
