# 统一身份平台架构设计

> 跨产品统一用户身份与资源共享平台设计方案

## 1. 架构设计方案

### 1.1 架构名称与原理

**架构名称：统一身份平台 (Unified Identity Platform, UIP)**

该架构在业界也被称为：
- **身份即服务 (Identity as a Service, IDaaS)** - 将身份管理作为独立服务提供
- **集中式身份管理 (Centralized Identity Management)** - 统一管理所有产品的用户身份
- **单点登录平台 (Single Sign-On Platform)** - 一次登录，全平台通用
- **跨产品身份联邦 (Cross-Product Identity Federation)** - 多产品共享身份体系

#### 核心原理

```
┌─────────────────────────────────────────────────────────────────┐
│                       统一身份平台                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   用户身份   │  │  积分钱包   │  │   资源账本（配额/权益）  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
           │                │                    │
           ▼                ▼                    ▼
    ┌──────────────────────────────────────────────────┐
    │              身份网关 (API Gateway)              │
    │           Token 校验 / 资源查询 / 积分扣减        │
    └──────────────────────────────────────────────────┘
           │                │                    │
           ▼                ▼                    ▼
    ┌───────────┐    ┌───────────┐    ┌───────────────┐
    │   AIGET   │    │   MEMAI   │    │   MORYFLOW    │
    │ (网页抓取) │    │ (AI记忆)  │    │  (工作流)     │
    └───────────┘    └───────────┘    └───────────────┘
```

**核心思想**：将用户身份、积分钱包、资源配额从各个业务系统中抽离出来，形成一个独立的「身份平台」。各业务系统（AIGET、MEMAI、MORYFLOW）作为「资源消费者」，通过统一的网关 API 来：
1. 验证用户身份（这个用户是谁？）
2. 查询用户权益（这个用户能用什么功能？）
3. 扣减/查询积分（这个用户还有多少积分？）

#### 架构分层

| 层级 | 职责 | 核心组件 |
|------|------|----------|
| **身份层** | 用户认证、会话管理、个人资料 | User（用户）、Session（会话）、Account（账号）、Profile（资料） |
| **钱包层** | 通用积分/Credits 管理 | Wallet（钱包）、WalletTransaction（交易记录）、PurchaseOrder（购买订单） |
| **权益层** | 订阅权益、产品授权 | Subscription（订阅）、ProductEntitlement（产品权益）、License（许可证） |
| **网关层** | 对外 API、Token 校验 | 认证 API、资源 API、Webhook |
| **产品层** | 各业务系统 | AIGET、MEMAI、MORYFLOW |

### 1.2 核心优势分析

#### 优势一：单一数据源 (Single Source of Truth)

```
改造前（分散式）：                    改造后（统一式）：
┌─────────┐ ┌─────────┐ ┌─────────┐  ┌─────────────────────┐
│ AIGET   │ │ MEMAI   │ │MORYFLOW │  │     统一身份平台     │
│ ─────── │ │ ─────── │ │ ─────── │  │   ─────────────────  │
│ 用户表  │ │ 用户表  │ │ 用户表  │  │   用户表（唯一）     │
│ 配额表  │ │ 配额表  │ │ 积分表  │  │   钱包（统一）       │
│ 订阅表  │ │ 订阅表  │ │ 订阅表  │  │   订阅（统一）       │
└─────────┘ └─────────┘ └─────────┘  └─────────────────────┘
     ×3 套用户表                           1 套用户表
     ×3 套配额系统                         1 套钱包系统
     ×3 套支付对接                         1 套支付系统
```

**具体收益**：
- 用户只需注册一次，即可使用所有产品
- 积分/Credits 跨产品共享，可在任意产品消费
- 统一的支付入口，简化财务对账
- 避免同一用户在不同产品有不同的身份数据

#### 优势二：运营效率提升

| 场景 | 改造前（分散式） | 改造后（统一式） |
|------|-----------------|-----------------|
| 用户注册 | 每个产品单独注册，记住多套账号 | 一次注册，全平台通用 |
| 密码重置 | 每个产品单独处理 | 统一入口处理 |
| 积分充值 | 每个产品单独充值，不能互通 | 统一钱包，跨产品使用 |
| 订阅管理 | 每个产品单独订阅 | 统一订阅中心 |
| 用户支持 | 客服需要登录多系统查询用户状态 | 单一控制台查看全貌 |

#### 优势三：产品协同与交叉销售

```
用户旅程示例：
┌─────────────────────────────────────────────────────────────┐
│  1. 用户通过 AIGET（网页抓取）注册                           │
│  2. 购买 10,000 积分（$10）                                 │
│  3. 使用 3,000 积分进行网页抓取                             │
│  4. 发现 MEMAI（AI记忆）→ 已自动登录（单点登录）            │
│  5. 使用剩余 7,000 积分存储记忆数据                         │
│  6. 发现 MORYFLOW（工作流）→ 已自动登录                     │
│  7. 积分余额在所有产品中统一显示                            │
└─────────────────────────────────────────────────────────────┘
```

**交叉销售收益**：
- 用户在一个产品购买的积分，可以吸引其尝试其他产品
- 降低新产品的获客成本（已有用户直接使用）
- 提高用户粘性（积分余额激励持续使用）
- 用户生命周期价值 (LTV) 提升

#### 优势四：技术收益

| 收益 | 说明 |
|------|------|
| **代码复用** | Auth（认证）、Payment（支付）、Quota（配额）逻辑只需维护一份 |
| **安全集中化** | 安全漏洞修复一处，全平台生效 |
| **独立扩展** | 身份服务可独立扩展，不受业务服务影响 |
| **审计追踪** | 统一的操作日志，便于合规审计 |
| **A/B 测试** | 可在平台层面实施跨产品实验 |

#### 优势五：商业模式灵活性

```
支持的定价模式：
┌─────────────────────────────────────────────────────────────┐
│  1. 统一订阅：三个产品共用等级（$9/$29/$99 月付）           │
│     - 订阅即解锁所有产品对应等级功能                        │
│     - 每月获得订阅积分，跨产品使用                          │
│                                                             │
│  2. 积分加油包：按需购买（$10/$30/$100）                    │
│     - 积分永不过期，可在任意产品消费                        │
│     - 购买越多，赠送比例越高                                │
│                                                             │
│  3. 年付优惠：Starter $99/年、Pro $299/年                   │
│     - 相当于免 1-2 个月费用                                 │
│                                                             │
│  4. 免费层：注册即送少量积分体验                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 实施方案

### 2.1 核心业务流程

#### 流程一：用户注册与初始化

```
┌─────────┐     ┌──────────────────┐     ┌─────────────────┐
│  用户   │────▶│   任意产品       │────▶│   统一身份平台   │
│         │     │  （入口点）      │     │                 │
└─────────┘     └──────────────────┘     └─────────────────┘
                         │                        │
                         │  跳转到                │
                         │  /auth/signup          │
                         ▼                        ▼
                ┌──────────────────┐     ┌─────────────────┐
                │  统一登录页面    │────▶│  自动创建：      │
                │  （单点登录）    │     │  - 用户记录      │
                └──────────────────┘     │  - 钱包（余额0） │
                                         │  - 免费订阅      │
                                         └─────────────────┘
                                                  │
                         ┌────────────────────────┘
                         ▼
                ┌──────────────────┐
                │  跳转回原产品     │
                │  携带认证 Token   │
                └──────────────────┘
```

**关键点**：
1. 用户从任意产品入口注册，都会跳转到统一的登录/注册页面
2. 注册成功后自动创建钱包（余额为0）和免费订阅
3. 携带认证 Token 跳转回原产品，实现无缝登录

#### 流程二：跨产品单点登录

```
场景：用户已登录 AIGET，访问 MEMAI

┌─────────┐     ┌─────────┐     ┌──────────────────┐
│  AIGET  │     │  MEMAI  │     │   统一身份平台    │
│(已登录) │     │(未登录) │     │                  │
└─────────┘     └─────────┘     └──────────────────┘
     │               │                    │
     │   用户点击    │                    │
     │   MEMAI 链接  │                    │
     │──────────────▶│                    │
     │               │  检查会话          │
     │               │───────────────────▶│
     │               │                    │
     │               │  会话有效          │
     │               │◀───────────────────│
     │               │                    │
     │               │  创建本地          │
     │               │  会话 Token        │
     │               │                    │
     │   已登录      │                    │
     │◀──────────────│                    │
```

**会话策略**：
- **共享 Cookie**（同域名）：`*.yourdomain.com` 共享 session cookie
- **Token 交换**（跨域名）：产品 A 的 token 换取产品 B 的 session

#### 流程三：积分购买与消费

```
购买流程：
┌─────────┐     ┌──────────────────┐     ┌─────────────────┐
│  用户   │────▶│   支付页面       │────▶│  支付提供商      │
│         │     │  （统一入口）    │     │  (Creem/Stripe) │
└─────────┘     └──────────────────┘     └─────────────────┘
                         │                        │
                         │                        │ Webhook 回调
                         │                        ▼
                         │               ┌─────────────────┐
                         │               │  统一身份平台    │
                         │               │  钱包.积分      │
                         │               │  += 购买数量    │
                         │               └─────────────────┘

消费流程：
┌─────────┐     ┌─────────┐     ┌──────────────────┐
│  用户   │────▶│  产品   │────▶│   统一身份平台    │
│         │     │ (AIGET) │     │                  │
└─────────┘     └─────────┘     └──────────────────┘
                    │                    │
                    │  扣减积分请求       │
                    │  (产品: aiget,     │
                    │   数量: 10,        │
                    │   原因: 网页抓取)   │
                    │───────────────────▶│
                    │                    │
                    │  返回结果:         │
                    │  { 成功: true,     │
                    │    剩余: 990 }     │
                    │◀───────────────────│
                    │                    │
                    │  继续执行操作       │
```

**积分扣减规则**：
1. **预扣减**：操作前先扣减积分
2. **失败退还**：操作失败自动退还
3. **扣减优先级**：免费积分 → 订阅积分 → 购买积分
4. **审计追踪**：每笔交易记录产品、操作、数量

#### 流程四：订阅管理

```
┌─────────────────────────────────────────────────────────────┐
│                     统一订阅等级                             │
│  （三个产品共用，包含积分 + 全产品功能解锁）                 │
├─────────────────────────────────────────────────────────────┤
│  Starter 入门版                                              │
│  - 月付：$9/月                                              │
│  - 年付：$99/年（省 $9，相当于免 1 个月）                   │
│  - 积分：1,000 积分/月                                      │
│  - 权益：三个产品基础功能                                   │
├─────────────────────────────────────────────────────────────┤
│  Pro 专业版                                                  │
│  - 月付：$29/月                                             │
│  - 年付：$299/年（省 $49，相当于免 2 个月）                 │
│  - 积分：5,000 积分/月                                      │
│  - 权益：三个产品高级功能 + 优先支持                        │
├─────────────────────────────────────────────────────────────┤
│  Max 旗舰版                                                  │
│  - 月付：$99/月（仅支持月付）                               │
│  - 积分：20,000 积分/月                                     │
│  - 权益：三个产品全部功能 + 优先队列 + 专属支持             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     积分加油包                               │
│  （按需购买，永不过期，可在任意产品使用）                    │
├─────────────────────────────────────────────────────────────┤
│  小包：$10  →  1,200 积分（+20% 赠送）                      │
│  中包：$30  →  4,000 积分（+33% 赠送）                      │
│  大包：$100 →  15,000 积分（+50% 赠送）                     │
└─────────────────────────────────────────────────────────────┘
```

**权益检查流程**：
```
产品请求：
┌─────────┐     ┌─────────┐     ┌──────────────────┐
│  用户   │────▶│  产品   │────▶│   统一身份平台    │
└─────────┘     └─────────┘     └──────────────────┘
                    │                    │
                    │  检查权益          │
                    │  (产品: aiget,     │
                    │   功能: pro)       │
                    │───────────────────▶│
                    │                    │
                    │  返回结果:         │
                    │  { 有权限: true,   │
                    │    等级: "pro",    │
                    │    到期: ... }     │
                    │◀───────────────────│
```

#### 流程五：资源查询（仪表盘）

```
用户仪表盘请求：
┌─────────┐     ┌──────────────────┐     ┌─────────────────┐
│  用户   │────▶│   控制台应用     │────▶│  统一身份平台    │
│         │     │  （统一入口）    │     │                 │
└─────────┘     └──────────────────┘     └─────────────────┘
                         │                        │
                         │  GET /api/v1/me        │
                         │───────────────────────▶│
                         │                        │
                         │  返回数据:             │
                         │  {                     │
                         │    用户: {...},        │
                         │    钱包: {             │
                         │      总余额: 5000,     │
                         │      免费积分: 100,    │
                         │      订阅积分: 3000,   │
                         │      购买积分: 1900    │
                         │    },                  │
                         │    订阅列表: [...],    │
                         │    权益列表: [...]     │
                         │  }                     │
                         │◀───────────────────────│
```

### 2.2 关键数据结构设计

#### 核心身份表

```
┌─────────────────────────────────────────────────────────────┐
│                         用户表 (User)                        │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  email         : string (唯一，有索引)                      │
│  name          : string? (可选)                             │
│  emailVerified : boolean (是否已验证邮箱)                   │
│  image         : string? (头像URL)                          │
│  isAdmin       : boolean (是否管理员)                       │
│  createdAt     : datetime (创建时间)                        │
│  updatedAt     : datetime (更新时间)                        │
│  deletedAt     : datetime? (软删除时间)                     │
├─────────────────────────────────────────────────────────────┤
│  关联关系:                                                   │
│  - sessions     : Session[] (会话列表)                      │
│  - accounts     : Account[] (OAuth 账号)                    │
│  - profile      : UserProfile (用户资料)                    │
│  - wallet       : Wallet (钱包)                             │
│  - subscriptions: Subscription[] (订阅列表)                 │
│  - entitlements : ProductEntitlement[] (权益列表)           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     用户资料表 (UserProfile)                 │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  userId        : string (外键，唯一)                        │
│  displayName   : string? (显示名称)                         │
│  avatarUrl     : string? (头像URL)                          │
│  timezone      : string? (时区)                             │
│  locale        : string? (语言偏好)                         │
│  metadata      : json? (扩展字段)                           │
└─────────────────────────────────────────────────────────────┘
```

#### 钱包与交易表

```
┌─────────────────────────────────────────────────────────────┐
│                        钱包表 (Wallet)                       │
├─────────────────────────────────────────────────────────────┤
│  id                  : cuid (主键)                          │
│  userId              : string (外键，唯一)                  │
│  ──────────────── 积分余额 ────────────────                 │
│  freeCredits         : int (免费积分，每月重置)             │
│  subscriptionCredits : int (订阅积分，来自有效订阅)         │
│  purchasedCredits    : int (购买积分，按量付费)             │
│  ──────────────── 周期追踪 ────────────────                 │
│  periodStartAt       : datetime (当前周期开始)              │
│  periodEndAt         : datetime (当前周期结束)              │
│  ──────────────── 计算字段 ────────────────                 │
│  totalBalance        : int (计算值：所有积分之和)           │
│  createdAt           : datetime                             │
│  updatedAt           : datetime                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  钱包交易表 (WalletTransaction)              │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  walletId      : string (外键)                              │
│  ──────────────── 交易信息 ────────────────                 │
│  type          : enum (充值/扣减/退款/重置)                 │
│                  CREDIT / DEBIT / REFUND / RESET            │
│  source        : enum (来源：免费/订阅/购买)                │
│                  FREE / SUBSCRIPTION / PURCHASED            │
│  amount        : int (正数为充值，负数为扣减)               │
│  balanceAfter  : int (交易后余额)                           │
│  ──────────────── 上下文 ────────────────                   │
│  product       : string? (产品：aiget/memai/moryflow)       │
│  operation     : string? (操作：scrape/memory_store 等)     │
│  referenceId   : string? (关联ID：job_id/order_id 等)       │
│  description   : string? (描述)                             │
│  ──────────────── 元数据 ────────────────                   │
│  metadata      : json? (扩展数据)                           │
│  createdAt     : datetime                                   │
│  ──────────────── 索引 ────────────────                     │
│  索引: (walletId, createdAt)                                │
│  索引: (product, createdAt)                                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    购买订单表 (PurchaseOrder)                │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  userId        : string (外键)                              │
│  walletId      : string (外键)                              │
│  ──────────────── 订单信息 ────────────────                 │
│  type          : enum (积分购买/订阅)                       │
│                  CREDITS / SUBSCRIPTION                     │
│  status        : enum (待支付/已完成/失败/已退款)           │
│                  PENDING / COMPLETED / FAILED / REFUNDED    │
│  amount        : decimal (金额，美元)                       │
│  credits       : int? (如果是积分购买，购买的积分数)        │
│  ──────────────── 支付提供商 ────────────────               │
│  provider      : enum (CREEM / STRIPE)                      │
│  externalId    : string (提供商的订单ID)                    │
│  externalData  : json? (提供商返回数据)                     │
│  ──────────────── 时间戳 ────────────────                   │
│  createdAt     : datetime                                   │
│  completedAt   : datetime?                                  │
└─────────────────────────────────────────────────────────────┘
```

#### 订阅与权益表

```
┌─────────────────────────────────────────────────────────────┐
│                      订阅表 (Subscription)                   │
├─────────────────────────────────────────────────────────────┤
│  id                     : cuid (主键)                       │
│  userId                 : string (外键)                     │
│  ──────────────── 套餐信息 ────────────────                 │
│  planId                 : string (外键，关联订阅套餐)       │
│  tier                   : enum (等级)                       │
│                          FREE / STARTER / PRO / MAX         │
│  status                 : enum (状态)                       │
│                          ACTIVE / CANCELED / PAST_DUE /     │
│                          EXPIRED / TRIALING                 │
│  ──────────────── 计费周期 ────────────────                 │
│  currentPeriodStart     : datetime (当前周期开始)           │
│  currentPeriodEnd       : datetime (当前周期结束)           │
│  cancelAtPeriodEnd      : boolean (周期结束时是否取消)      │
│  ──────────────── 积分分配 ────────────────                 │
│  creditsPerPeriod       : int (每周期包含的积分)            │
│  creditsUsedThisPeriod  : int (本周期已使用的积分)          │
│  ──────────────── 支付提供商 ────────────────               │
│  provider               : enum (CREEM / STRIPE)             │
│  externalCustomerId     : string? (提供商客户ID)            │
│  externalSubscriptionId : string? (提供商订阅ID)            │
│  ──────────────── 时间戳 ────────────────                   │
│  createdAt              : datetime                          │
│  updatedAt              : datetime                          │
│  canceledAt             : datetime?                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  产品权益表 (ProductEntitlement)             │
├─────────────────────────────────────────────────────────────┤
│  id            : cuid (主键)                                │
│  userId        : string (外键)                              │
│  subscriptionId: string? (外键，如果来自订阅)               │
│  ──────────────── 权益信息 ────────────────                 │
│  product       : enum (产品)                                │
│                  AIGET / MEMAI / MORYFLOW / PLATFORM        │
│  feature       : string (功能：pro/enterprise/具体功能名)   │
│  tier          : string? (产品特定的等级)                   │
│  ──────────────── 有效期 ────────────────                   │
│  isActive      : boolean (是否有效)                         │
│  grantedAt     : datetime (授权时间)                        │
│  expiresAt     : datetime? (过期时间)                       │
│  ──────────────── 来源 ────────────────                     │
│  source        : enum (来源)                                │
│                  SUBSCRIPTION / LICENSE / MANUAL / TRIAL    │
│  sourceId      : string? (来源ID：license_id/优惠码等)      │
│  ──────────────── 索引 ────────────────                     │
│  唯一索引: (userId, product, feature)                       │
│  索引: (userId, isActive)                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       许可证表 (License)                     │
├─────────────────────────────────────────────────────────────┤
│  id             : cuid (主键)                               │
│  userId         : string? (外键，未激活时为空)              │
│  ──────────────── 许可证信息 ────────────────               │
│  licenseKey     : string (唯一，有索引)                     │
│  product        : enum (产品)                               │
│                   AIGET / MEMAI / MORYFLOW / BUNDLE         │
│  tier           : string (等级：standard/pro/enterprise)    │
│  ──────────────── 有效期 ────────────────                   │
│  status         : enum (状态)                               │
│                   ACTIVE / REVOKED / EXPIRED / PENDING      │
│  maxActivations : int (最大激活次数，默认1)                 │
│  activationCount: int (已激活次数，默认0)                   │
│  expiresAt      : datetime? (过期时间)                      │
│  ──────────────── 元数据 ────────────────                   │
│  metadata       : json? (客户名称、订单号等)                │
│  createdAt      : datetime                                  │
│  activatedAt    : datetime?                                 │
└─────────────────────────────────────────────────────────────┘
```

#### 配置表

```
┌─────────────────────────────────────────────────────────────┐
│                   订阅套餐表 (SubscriptionPlan)              │
├─────────────────────────────────────────────────────────────┤
│  id               : string (主键，如 "pro_monthly")         │
│  name             : string (显示名称)                       │
│  tier             : enum (等级)                             │
│                    FREE / STARTER / PRO / MAX               │
│  ──────────────── 定价 ────────────────                     │
│  priceMonthly     : decimal (月付价格，美元)                │
│  priceYearly      : decimal? (年付价格，null表示不支持年付) │
│  ──────────────── 积分 ────────────────                     │
│  creditsPerMonth  : int (每月积分)                          │
│  ──────────────── 功能 ────────────────                     │
│  features         : json (功能标志和限制)                   │
│  ──────────────── 元数据 ────────────────                   │
│  isActive         : boolean (是否可购买)                    │
│  sortOrder        : int (显示顺序)                          │
│  createdAt        : datetime                                │
│  updatedAt        : datetime                                │
└─────────────────────────────────────────────────────────────┘

套餐配置示例:
┌──────────────┬─────────┬─────────┬─────────┬──────────┐
│    套餐       │  FREE   │ STARTER │   PRO   │   MAX    │
├──────────────┼─────────┼─────────┼─────────┼──────────┤
│ 月付价格      │   $0    │   $9    │   $29   │   $99    │
│ 年付价格      │    -    │   $99   │  $299   │    -     │
│ 每月积分      │   50    │  1,000  │  5,000  │  20,000  │
│ 三产品解锁    │  基础   │  基础   │  高级   │   全部   │
│ 并发限制      │    2    │    5    │   10    │    20    │
└──────────────┴─────────┴─────────┴─────────┴──────────┘

┌─────────────────────────────────────────────────────────────┐
│                   积分包表 (CreditPackage)                   │
├─────────────────────────────────────────────────────────────┤
│  id               : string (主键，如 "credits_small")       │
│  name             : string (显示名称)                       │
│  price            : decimal (价格，美元)                    │
│  credits          : int (获得的积分数)                      │
│  bonusPercent     : int (赠送比例，如 20 表示 +20%)         │
│  isActive         : boolean                                 │
│  sortOrder        : int                                     │
└─────────────────────────────────────────────────────────────┘

积分包配置:
┌──────────┬────────┬────────┬──────────┐
│   名称   │  价格  │  积分  │ 赠送比例 │
├──────────┼────────┼────────┼──────────┤
│  小包    │  $10   │ 1,200  │   +20%   │
│  中包    │  $30   │ 4,000  │   +33%   │
│  大包    │  $100  │ 15,000 │   +50%   │
└──────────┴────────┴────────┴──────────┘

features JSON 示例（三产品统一解锁）:
{
  "products": {
    "aiget": { "enabled": true },
    "memai": { "enabled": true },
    "moryflow": { "enabled": true }
  },
  "limits": {
    "concurrency": 10,
    "apiRequestsPerMinute": 100,
    "dataRetentionDays": 90
  }
}
```

#### 产品用量追踪

```
┌─────────────────────────────────────────────────────────────┐
│                  每日用量表 (ProductUsageDaily)              │
├─────────────────────────────────────────────────────────────┤
│  id               : cuid (主键)                             │
│  userId           : string (外键)                           │
│  product          : enum (产品：AIGET/MEMAI/MORYFLOW)       │
│  date             : date (日期，有索引)                     │
│  ──────────────── 用量指标 ────────────────                 │
│  requestCount     : int (请求次数)                          │
│  creditsUsed      : int (消耗积分)                          │
│  ──────────────── 积分来源明细 ────────────────             │
│  creditsFree      : int (消耗的免费积分)                    │
│  creditsSub       : int (消耗的订阅积分)                    │
│  creditsPurchased : int (消耗的购买积分)                    │
│  ──────────────── 产品特定指标 ────────────────             │
│  metadata         : json? (产品特定的指标)                  │
│  ──────────────── 索引 ────────────────                     │
│  唯一索引: (userId, product, date)                          │
│  索引: (userId, date)                                       │
│  索引: (product, date)                                      │
└─────────────────────────────────────────────────────────────┘

AIGET 的 metadata 示例:
{
  "pagesScraped": 1500,
  "bytesDownloaded": 52428800,
  "cacheHitRate": 0.35
}
```

### 2.3 API 网关设计

#### 接口结构

```
统一身份平台 API:
/api/v1/
├── auth/                    # 认证（Better Auth）
│   ├── signup               # 注册
│   ├── signin               # 登录
│   ├── signout              # 登出
│   ├── session              # 会话
│   └── ...
├── users/                   # 用户管理
│   ├── me                   # 当前用户资料
│   ├── me/profile           # 更新资料
│   └── me/delete            # 删除账号
├── wallet/                  # 积分管理
│   ├── balance              # 查询余额
│   ├── transactions         # 交易记录
│   ├── deduct               # 扣减积分（内部）
│   └── refund               # 退还积分（内部）
├── subscriptions/           # 订阅管理
│   ├── current              # 当前订阅
│   ├── plans                # 可用套餐
│   ├── checkout             # 开始订阅
│   └── cancel               # 取消订阅
├── entitlements/            # 产品权益
│   ├── check                # 检查权益
│   └── list                 # 列出所有权益
├── purchases/               # 积分购买
│   ├── packages             # 可用套餐
│   └── checkout             # 购买积分
└── admin/                   # 管理员接口
    ├── users/
    ├── wallets/
    └── subscriptions/
```

#### 服务间通信

```
产品通过以下方式调用统一身份平台：

1. REST API（推荐用于大多数场景）
   POST /api/v1/wallet/deduct
   {
     "userId": "user_xxx",
     "amount": 10,
     "product": "aiget",
     "operation": "scrape",
     "referenceId": "job_yyy"
   }

2. gRPC（用于高吞吐场景）
   WalletService.Deduct(DeductRequest)

3. 消息队列（用于异步操作）
   队列: identity.wallet.deduct
   消息: { userId, amount, product, ... }
```

### 2.4 迁移策略

#### 第一阶段：身份平台搭建

```
第 1-2 周:
├── 部署统一身份平台作为新服务
├── 创建数据库及新表结构
├── 实现核心认证接口
└── 配置 SSO Cookie/Token 共享

第 3-4 周:
├── 实现钱包服务
├── 实现订阅服务
├── 对接支付提供商
└── 搭建管理后台
```

#### 第二阶段：产品接入

```
第 5-6 周 (AIGET):
├── 将认证模块替换为身份平台客户端
├── 迁移现有用户到身份平台
├── 将配额系统替换为钱包 API 调用
└── 测试跨产品单点登录

第 7-8 周 (MEMAI):
├── 同 AIGET 的接入步骤
└── 验证跨产品积分共享

第 9-10 周 (MORYFLOW):
├── 同上接入步骤
├── 迁移积分到统一钱包
└── 最终跨产品测试
```

#### 数据迁移方案

```
用户迁移:
1. 从产品 A 导出用户数据
2. 导入到身份平台（生成新 ID 或保留旧 ID）
3. 创建 ID 映射表
4. 更新产品 A 使用新用户 ID

配额/积分迁移:
1. 快照所有现有余额
2. 在身份平台创建钱包记录
3. 充入初始余额
4. 切换产品使用钱包 API
5. 验证余额一致

订阅迁移:
1. 导出有效订阅
2. 映射产品等级到平台等级
3. 创建订阅 + 权益记录
4. 验证功能访问不变
```

---

## 3. 部署架构

### 3.1 推荐基础设施

```
┌─────────────────────────────────────────────────────────────┐
│                       负载均衡器                             │
│                  (Cloudflare / AWS ALB)                     │
└─────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  统一身份平台   │  │     AIGET       │  │    MEMAI        │
│  (id.domain)   │  │ (api.domain)    │  │ (mem.domain)    │
│                 │  │                 │  │                 │
│ - 认证服务      │  │ - 抓取服务      │  │ - 记忆 API      │
│ - 钱包服务      │  │ - 浏览器池      │  │ - 向量数据库    │
│ - 订阅服务      │  │                 │  │                 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                    │                    │
         └────────────────────┼────────────────────┘
                              ▼
                    ┌─────────────────┐
                    │   PostgreSQL    │
                    │  (共享或独立)    │
                    └─────────────────┘
```

### 3.2 数据库策略选项

| 方案 | 说明 | 优点 | 缺点 |
|------|------|------|------|
| **共享数据库** | 所有服务使用同一个 PostgreSQL | 简单，易于跨表查询 | 耦合，扩展受限 |
| **Schema 隔离** | 同一数据库，不同 Schema | 逻辑隔离 | 仍在数据库层面耦合 |
| **独立数据库** | 每个服务独立数据库 | 真正隔离 | 跨服务查询困难 |

**建议**：先采用 **Schema 隔离**，待规模需要时再迁移到 **独立数据库**。

---

## 4. 安全考虑

### 4.1 Token 策略

```
Token 类型：
┌─────────────────────────────────────────────────────────────┐
│  1. 会话 Token（HTTP-only Cookie）                          │
│     - 用于 Web 应用                                         │
│     - 域名: .yourdomain.com（子域名共享）                   │
│     - 有效期: 7 天（活动时刷新）                            │
│                                                             │
│  2. Bearer Token（Authorization 头）                        │
│     - 用于移动端/API 客户端                                 │
│     - 有效期: 30 天                                         │
│     - 刷新 Token: 90 天                                     │
│                                                             │
│  3. 服务 Token（内部）                                      │
│     - 用于服务间认证                                        │
│     - 短期有效，自动轮换                                    │
│     - IP 白名单 + mTLS                                      │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 服务间安全

```
产品 → 统一身份平台：
1. 服务 API Key（每月轮换）
2. 请求签名（HMAC）
3. IP 白名单
4. 按服务限流
5. 所有请求审计日志
```

---

## 5. 总结

### 架构选择理由

| 考虑因素 | 决策 |
|----------|------|
| 用户体验 | 一个账号，无缝跨产品访问 |
| 开发体验 | 只需维护一套认证/支付集成 |
| 商业灵活 | 积分模式支持交叉销售和套餐捆绑 |
| 技术扩展 | 身份层独立扩展 |
| 安全 | 集中式安全控制和审计 |

### 关键成功指标

- **用户转化率**：使用 2 个以上产品的用户占比
- **积分利用率**：跨产品积分使用率
- **支持效率**：用户身份问题减少量
- **开发速度**：新产品上线时间缩短

### 下一步行动

1. 评审并批准架构设计
2. 创建统一身份平台代码仓库
3. 实现核心服务（认证、钱包、订阅）
4. 接入第一个产品（建议以 AIGET 为试点）
5. 逐步迁移其余产品

---

## 6. Monorepo 合并可行性评估

### 6.1 现状分析

#### 三个仓库结构对比

```
┌─────────────────────────────────────────────────────────────┐
│                        AIGET                                 │
├─────────────────────────────────────────────────────────────┤
│  apps/                                                       │
│  ├── server      NestJS 后端 (网页抓取引擎)                  │
│  ├── console     用户控制台 (React + Vite)                   │
│  ├── admin       管理后台 (React + Vite)                     │
│  ├── www         落地页 (TanStack Start)                     │
│  └── docs        文档站 (TanStack Start + Fumadocs)          │
│  packages/                                                   │
│  ├── ui          UI 组件库 (shadcn/ui)                       │
│  ├── shared-types 共享类型                                   │
│  ├── embed       嵌入脚本                                    │
│  └── embed-react React 嵌入组件                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                        MEMAI                                 │
├─────────────────────────────────────────────────────────────┤
│  apps/                                                       │
│  ├── server      NestJS 后端 (AI 记忆服务)                   │
│  ├── console     用户控制台                                  │
│  ├── admin       管理后台                                    │
│  ├── www         落地页                                      │
│  └── docs        文档站                                      │
│  packages/                                                   │
│  ├── ui          UI 组件库 (与 AIGET 几乎相同)               │
│  └── shared-types 共享类型                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       MORYFLOW                               │
├─────────────────────────────────────────────────────────────┤
│  apps/                                                       │
│  ├── server      NestJS 后端 (工作流引擎)                    │
│  ├── admin       管理后台                                    │
│  ├── www         落地页                                      │
│  ├── mobile      移动端 (React Native)                       │
│  ├── pc          桌面端                                      │
│  └── docs        文档站                                      │
│  packages/                                                   │
│  ├── ui          UI 组件库 (更丰富，含 AI 组件)              │
│  ├── agents-*    Agent 相关包 (10+ 个)                       │
│  ├── shared-*    共享包 (api/i18n/sync)                      │
│  └── tiptap      富文本编辑器                                │
└─────────────────────────────────────────────────────────────┘
```

#### 技术栈重合度

| 技术层 | AIGET | MEMAI | MORYFLOW | 重合度 |
|--------|-------|-------|----------|--------|
| 包管理器 | pnpm workspace | pnpm workspace | pnpm workspace | 100% |
| 后端框架 | NestJS 11 | NestJS 11 | NestJS 11 | 100% |
| 数据库 | Prisma + PostgreSQL | Prisma + PostgreSQL | Prisma + PostgreSQL | 100% |
| 认证 | Better Auth | Better Auth | Better Auth | 100% |
| 队列 | BullMQ + Redis | BullMQ + Redis | BullMQ + Redis | 100% |
| 支付 | Creem | Creem | Creem | 100% |
| 前端框架 | React 19 | React 19 | React 19 | 100% |
| 样式 | TailwindCSS v4 | TailwindCSS v4 | TailwindCSS v4 | 100% |
| UI 组件 | shadcn/ui (Radix) | shadcn/ui (Radix) | shadcn/ui (Radix) | ~90% |
| 类型校验 | Zod | Zod | Zod | 100% |
| 邮件 | Resend | Resend | Resend | 100% |
| 日志 | Pino | Pino | Pino | 100% |

#### 共享依赖分析

```
完全相同的依赖（三个项目都有）:
├── @nestjs/* (common, core, config, swagger, throttler, bullmq, schedule)
├── @prisma/client, @prisma/adapter-pg
├── better-auth
├── bullmq, ioredis
├── creem_io
├── resend
├── zod
├── pino, nestjs-pino
├── bcryptjs
├── express
└── rxjs

AIGET 特有:
├── playwright (浏览器自动化)
├── sharp (图片处理)
├── turndown (HTML→Markdown)
├── jsdom (DOM 解析)
└── @mozilla/readability (正文提取)

MORYFLOW 特有:
├── @ai-sdk/* (anthropic, openai, google)
├── ai (Vercel AI SDK)
├── agents-* 包 (自研 Agent 框架)
├── @xyflow/react (流程图)
└── motion (动画)
```

### 6.2 可行性评估

#### 结论：✅ 高度可行

三个项目的技术栈高度统一，合并为 Monorepo 不仅可行，而且**强烈推荐**。

#### 合并收益

| 收益 | 说明 |
|------|------|
| **依赖去重** | node_modules 大小可减少 40-60%，安装速度提升 |
| **UI 组件统一** | AIGET 和 MEMAI 的 UI 包几乎相同，可直接合并 |
| **共享模块复用** | auth、payment、quota 等核心模块只需维护一份 |
| **类型安全** | 跨产品类型共享，编译时发现问题 |
| **原子变更** | 跨产品重构可在一个 PR 内完成 |
| **CI/CD 简化** | 统一的构建和部署流程 |
| **开发体验** | 一个仓库，一个 IDE 窗口，统一的开发环境 |

#### 风险与挑战

| 风险 | 缓解措施 |
|------|----------|
| 仓库体积增大 | 使用 Git LFS 管理大文件，配置 .gitignore |
| CI 时间增长 | 使用 Turborepo 增量构建，只构建变更的包 |
| 权限管理复杂 | 使用 CODEOWNERS 按目录分配审核权限 |
| 迁移工作量 | 分阶段迁移，先合并共享包，再合并应用 |

### 6.3 推荐的 Monorepo 结构

```
unified-platform/                    # 新仓库名
├── apps/
│   ├── identity/                    # 统一身份平台服务（新）
│   │   ├── server/                  # 身份服务后端
│   │   └── console/                 # 统一用户中心前端
│   ├── aiget/                       # AIGET 产品
│   │   ├── server/                  # 网页抓取服务
│   │   ├── console/                 # 用户控制台
│   │   └── www/                     # 落地页
│   ├── memai/                       # MEMAI 产品
│   │   ├── server/                  # AI 记忆服务
│   │   ├── console/                 # 用户控制台
│   │   └── www/                     # 落地页
│   ├── moryflow/                    # MORYFLOW 产品
│   │   ├── server/                  # 工作流服务
│   │   ├── mobile/                  # 移动端
│   │   ├── pc/                      # 桌面端
│   │   └── www/                     # 落地页
│   ├── admin/                       # 统一管理后台（新）
│   └── docs/                        # 统一文档站（新）
├── packages/
│   ├── ui/                          # 统一 UI 组件库
│   ├── shared-types/                # 跨产品共享类型
│   ├── shared-api/                  # API 客户端
│   ├── shared-auth/                 # 身份认证客户端
│   ├── shared-config/               # 共享配置
│   ├── agents-core/                 # Agent 核心（来自 moryflow）
│   ├── agents-*/                    # Agent 相关包
│   └── scraper-core/                # 抓取核心（来自 aiget）
├── tooling/
│   ├── eslint-config/               # ESLint 配置
│   ├── typescript-config/           # TypeScript 配置
│   └── tailwind-config/             # Tailwind 配置
├── turbo.json                       # Turborepo 配置
├── pnpm-workspace.yaml
└── package.json
```

### 6.4 迁移步骤

#### 第一阶段：准备工作（1 周）

```
1. 创建新仓库 unified-platform
2. 配置 pnpm workspace + Turborepo
3. 设置统一的 ESLint、TypeScript、Tailwind 配置
4. 配置 CI/CD (GitHub Actions)
```

#### 第二阶段：合并共享包（2 周）

```
1. 合并三个 UI 包为统一的 @platform/ui
   - 以 MORYFLOW 的 UI 为基础（功能最全）
   - 补充 AIGET/MEMAI 特有的组件

2. 创建 @platform/shared-types
   - 合并三个 shared-types
   - 定义跨产品通用类型

3. 迁移 MORYFLOW 的 agents-* 包
```

#### 第三阶段：合并应用（3 周）

```
1. 迁移 AIGET
   - 移动 apps/server → apps/aiget/server
   - 移动 apps/console → apps/aiget/console
   - 更新 import 路径

2. 迁移 MEMAI
   - 同上操作

3. 迁移 MORYFLOW
   - 移动应用到 apps/moryflow/
   - 保留 mobile、pc 等特有应用
```

#### 第四阶段：创建身份平台（2 周）

```
1. 创建 apps/identity/server
   - 从 AIGET server 提取 auth、user、quota 模块
   - 实现钱包、订阅等新模块

2. 创建 apps/identity/console
   - 统一用户中心

3. 创建 apps/admin
   - 合并三个 admin 为统一管理后台
```

#### 第五阶段：集成与测试（2 周）

```
1. 各产品接入身份平台
2. 端到端测试
3. 性能测试
4. 文档更新
```

### 6.5 Turborepo 配置示例

```json
// turbo.json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", "build/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "typecheck": {
      "dependsOn": ["^build"]
    },
    "test": {
      "dependsOn": ["^build"]
    }
  },
  "ui": "tui"
}
```

```yaml
# pnpm-workspace.yaml
packages:
  - "apps/*"
  - "apps/*/server"
  - "apps/*/console"
  - "apps/*/www"
  - "packages/*"
  - "tooling/*"
```

### 6.6 命名规范建议

| 类型 | 命名模式 | 示例 |
|------|----------|------|
| 应用包 | `@platform/{product}-{app}` | `@platform/aiget-server` |
| 共享包 | `@platform/shared-{name}` | `@platform/shared-types` |
| UI 包 | `@platform/ui` | 唯一 |
| 工具包 | `@platform/{name}-config` | `@platform/eslint-config` |
| Agent 包 | `@platform/agents-{name}` | `@platform/agents-core` |

---

*文档版本: 1.0*
*创建日期: 2026-01-04*
*作者: Claude (AI 助手)*
