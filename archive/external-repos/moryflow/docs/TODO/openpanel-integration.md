# OpenPanel 产品分析集成方案

> 状态：待评估
> 优先级：P1
> 预计收益：高

## 1. 项目背景

### 1.1 OpenPanel 简介

[OpenPanel](https://github.com/Openpanel-dev/openpanel) 是一个开源的产品分析平台，定位为 Mixpanel + Plausible 的结合体，也是 Google Analytics 的优秀替代品。

**核心特点**：

- 开源免费，可自托管
- 隐私优先，默认无 Cookie 追踪
- GDPR 合规
- 功能全面：漏斗、用户画像、会话历史、A/B 测试
- 技术栈现代：Next.js + Clickhouse + tRPC + Tailwind

**技术栈对比**：

| 组件 | OpenPanel | Moryflow |
|------|-----------|----------|
| 前端框架 | Next.js / React | React / Electron |
| 样式方案 | Tailwind + Shadcn | Tailwind + 自研组件 |
| 类型系统 | TypeScript | TypeScript |
| 包管理 | pnpm workspace | pnpm workspace |
| API 层 | tRPC | NestJS |

### 1.2 当前现状

Moryflow 目前**缺少用户行为分析能力**：

- 没有用户行为追踪
- 无法量化功能使用率
- 缺少转化漏斗分析
- 没有 A/B 测试能力
- 产品决策依赖直觉而非数据

仅有的分析是内部的 Agent Tool 性能监控（见 `apps/admin/src/pages/ToolAnalyticsPage.tsx`），用于技术运维而非产品分析。

---

## 2. 整体收益分析

### 2.1 产品层面

| 收益 | 说明 | 影响程度 |
|------|------|----------|
| **数据驱动决策** | 用真实数据指导功能迭代，避免盲目开发 | 高 |
| **用户理解** | 深入了解用户如何使用产品，发现使用痛点 | 高 |
| **增长优化** | 识别转化瓶颈，优化用户旅程 | 高 |
| **功能评估** | 量化新功能效果，决定保留/迭代/下线 | 中 |
| **留存提升** | 分析流失原因，针对性改进 | 中 |

### 2.2 技术层面

| 收益 | 说明 | 影响程度 |
|------|------|----------|
| **隐私合规** | 无 Cookie 追踪，天然 GDPR 合规 | 高 |
| **数据自主** | 自托管，数据完全掌控，无第三方依赖 | 高 |
| **多端统一** | 一套方案覆盖 PC、Mobile、Web | 中 |
| **技术契合** | 技术栈高度一致，集成成本低 | 中 |
| **可扩展性** | 开源可定制，按需扩展 | 中 |

### 2.3 商业层面

| 收益 | 说明 | 影响程度 |
|------|------|----------|
| **成本节省** | 相比 Mixpanel/Amplitude 可节省 $500-2000/月 | 高 |
| **付费转化** | 分析付费漏斗，优化转化率 | 高 |
| **市场定位** | 了解核心用户画像，精准营销 | 中 |

---

## 3. 计划实现的功能列表

### 3.1 Phase 1：基础埋点（1-2 周）

| 功能 | 优先级 | 复杂度 |
|------|--------|--------|
| SDK 集成（PC/Mobile） | P0 | 低 |
| 用户身份识别 | P0 | 低 |
| 基础事件追踪 | P0 | 低 |
| 页面浏览统计 | P0 | 低 |

### 3.2 Phase 2：核心分析（2-3 周）

| 功能 | 优先级 | 复杂度 |
|------|--------|--------|
| 功能使用率统计 | P0 | 中 |
| 用户画像构建 | P1 | 中 |
| 会话分析 | P1 | 中 |
| 自定义仪表板 | P1 | 中 |

### 3.3 Phase 3：进阶能力（3-4 周）

| 功能 | 优先级 | 复杂度 |
|------|--------|--------|
| 转化漏斗分析 | P1 | 中 |
| 留存分析 | P1 | 中 |
| A/B 测试 | P2 | 高 |
| 智能告警 | P2 | 中 |

---

## 4. 各项功能收益分析

### 4.1 SDK 集成与用户身份识别

**功能描述**：
- 在 PC（Electron）和 Mobile（React Native）中集成 OpenPanel SDK
- 实现用户登录状态与分析用户的关联
- 支持匿名用户到登录用户的身份合并

**具体收益**：

| 收益点 | 量化指标 | 说明 |
|--------|----------|------|
| 用户行为可追踪 | 100% 用户覆盖 | 每个用户行为都有数据记录 |
| 跨设备识别 | 减少 30-50% 重复用户计数 | 同一用户多设备使用可统一识别 |
| 数据准确性 | 提升至 95%+ | 用户级别的精准分析基础 |

**实现要点**：
```typescript
// PC 端集成示例
import { Openpanel } from '@openpanel/web';

const op = new Openpanel({
  clientId: 'your-client-id',
  trackScreenViews: true,
  trackOutgoingLinks: true,
});

// 用户登录时关联身份
op.setProfile({
  profileId: user.id,
  email: user.email,
  tier: user.tier,
});
```

---

### 4.2 基础事件追踪

**功能描述**：
- 追踪核心用户行为事件
- 建立统一的事件命名规范
- 收集关键业务数据

**事件清单**：

| 事件名 | 触发时机 | 关键属性 |
|--------|----------|----------|
| `note_created` | 创建笔记 | type, source |
| `note_edited` | 编辑笔记 | duration, word_count |
| `ai_chat_sent` | 发送 AI 消息 | model, tokens |
| `ai_tool_used` | 使用 AI 工具 | tool_name, success |
| `file_uploaded` | 上传文件 | file_type, size |
| `cloud_sync_triggered` | 触发云同步 | sync_type, file_count |
| `subscription_started` | 开始订阅 | plan, price |

**具体收益**：

| 收益点 | 量化指标 | 说明 |
|--------|----------|------|
| 功能热度排行 | Top 10 功能使用率 | 了解最受欢迎的功能 |
| 使用频率分析 | 日均事件量/用户 | 衡量用户活跃度 |
| 功能发现率 | 各功能触达率 | 识别未被发现的功能 |

---

### 4.3 功能使用率统计

**功能描述**：
- 统计各功能模块的使用情况
- 分析功能的使用深度和频率
- 对比不同用户群体的使用差异

**具体收益**：

| 收益点 | 场景示例 | 业务价值 |
|--------|----------|----------|
| **识别核心功能** | 发现 AI 对话占 60% 使用时长 | 优先投入资源优化核心功能 |
| **发现闲置功能** | 网页搜索功能仅 5% 用户使用 | 决定是否优化引导或下线 |
| **付费特性价值** | Pro 用户更多使用云同步 | 验证付费功能价值点 |
| **平台差异** | Mobile 用户更多使用语音输入 | 针对性优化各端体验 |

**示例分析维度**：

```
功能使用率 Top 10（过去 30 天）：
1. AI 对话        - 89% 用户使用，人均 23 次/周
2. 笔记编辑       - 95% 用户使用，人均 45 次/周
3. 云同步         - 67% 用户使用，人均 12 次/周
4. 文件上传       - 45% 用户使用，人均 3 次/周
5. 语音转文字     - 23% 用户使用，人均 5 次/周
...
```

---

### 4.4 用户画像构建

**功能描述**：
- 自动采集用户属性（设备、地区、语言等）
- 自定义用户分群标签
- 构建用户行为画像

**画像维度**：

| 维度 | 属性 | 用途 |
|------|------|------|
| **基础属性** | 注册时间、订阅等级、设备类型 | 用户分层 |
| **行为属性** | 使用频率、主要功能、AI 使用量 | 行为分析 |
| **价值属性** | LTV、付费意愿、推荐行为 | 商业决策 |

**具体收益**：

| 收益点 | 量化指标 | 说明 |
|--------|----------|------|
| 精准运营 | 转化率提升 20-30% | 针对不同用户群体定制策略 |
| 产品方向 | 核心用户画像清晰度 | 明确产品服务的目标人群 |
| 营销优化 | 获客成本降低 | 精准定位高价值用户渠道 |

**用户分群示例**：

```
高价值用户（占比 15%）：
- 特征：Pro 订阅，日活，AI 重度用户
- 行为：日均 AI 对话 10+，云同步活跃
- 策略：VIP 服务，收集反馈，推荐计划

潜在流失用户（占比 8%）：
- 特征：活跃度下降 50%，功能使用单一
- 行为：7 天未登录，仅用基础笔记
- 策略：激活邮件，功能引导，优惠刺激
```

---

### 4.5 转化漏斗分析

**功能描述**：
- 定义关键转化路径
- 分析各步骤转化率
- 识别流失节点

**核心漏斗**：

**漏斗 1：注册激活漏斗**
```
下载/访问 → 注册 → 创建首个笔记 → 使用 AI → 成为活跃用户

示例数据：
下载：10,000
├── 注册：6,000 (60%)
├── 创建首个笔记：4,200 (70%)
├── 使用 AI：2,100 (50%)
└── 活跃用户：840 (40%)

整体转化率：8.4%
```

**漏斗 2：付费转化漏斗**
```
活跃用户 → 触达付费功能 → 查看定价 → 发起支付 → 完成支付

示例数据：
活跃用户：1,000
├── 触达付费功能：700 (70%)
├── 查看定价：210 (30%)
├── 发起支付：84 (40%)
└── 完成支付：63 (75%)

付费转化率：6.3%
```

**具体收益**：

| 收益点 | 场景 | 预期效果 |
|--------|------|----------|
| **定位瓶颈** | 发现"使用 AI"步骤流失 50% | 优化新手引导，提升激活率 |
| **提升转化** | 发现定价页跳出率高 | A/B 测试定价展示方式 |
| **验证改进** | 优化后对比漏斗数据 | 量化改进效果 |

---

### 4.6 留存分析

**功能描述**：
- 追踪用户留存曲线
- 分析留存影响因素
- 识别关键留存行为

**留存指标**：

| 指标 | 定义 | 健康值 |
|------|------|--------|
| D1 留存 | 次日回访率 | > 40% |
| D7 留存 | 7 日回访率 | > 20% |
| D30 留存 | 30 日回访率 | > 10% |
| 周活跃留存 | 连续周活跃 | > 30% |

**具体收益**：

| 收益点 | 分析方法 | 业务价值 |
|--------|----------|----------|
| **识别魔法时刻** | 对比留存用户 vs 流失用户行为 | 发现"首周使用 AI 3次"留存率提升 50% |
| **优化激活流程** | 分析 D1 流失原因 | 优化新手引导，提升首日体验 |
| **预测流失** | 建立流失预警模型 | 提前干预，降低流失率 |

**示例分析**：

```
留存分析洞察：

✅ 高留存行为（D30 留存 +40%）：
- 首周使用 AI 对话 ≥ 3 次
- 开启云同步
- 创建 ≥ 5 个笔记

❌ 流失风险信号：
- 首日未完成引导
- 连续 3 天未登录
- 仅使用单一功能
```

---

### 4.7 A/B 测试

**功能描述**：
- 创建功能/UI 变体实验
- 自动分配流量
- 统计显著性分析

**应用场景**：

| 场景 | 测试内容 | 关注指标 |
|------|----------|----------|
| 新手引导 | 引导流程 A vs B | 激活率 |
| 定价页面 | 价格展示方式 | 付费转化率 |
| AI 功能 | 默认模型选择 | 使用满意度 |
| UI 布局 | 侧边栏 vs 顶栏 | 功能发现率 |

**具体收益**：

| 收益点 | 说明 | 预期效果 |
|--------|------|----------|
| **降低决策风险** | 小范围验证再全量上线 | 避免错误决策影响全部用户 |
| **量化改进效果** | 数据说话，非主观判断 | 团队共识，减少争论 |
| **持续优化** | 建立实验文化 | 产品持续迭代改进 |

---

### 4.8 智能告警

**功能描述**：
- 基于事件触发告警
- 漏斗异常检测
- 指标波动预警

**告警场景**：

| 告警类型 | 触发条件 | 响应动作 |
|----------|----------|----------|
| 转化率骤降 | 付费转化率下降 > 20% | 排查支付流程问题 |
| 错误率飙升 | AI 调用失败率 > 5% | 排查 API 服务状态 |
| 用户流失 | 日活下降 > 15% | 分析原因，发送召回 |
| 功能异常 | 某功能使用量突降 | 排查是否有 Bug |

**具体收益**：

| 收益点 | 说明 |
|--------|------|
| 问题早发现 | 实时监控，问题第一时间感知 |
| 减少损失 | 快速响应，降低问题影响范围 |
| 运营自动化 | 自动触发运营动作（如召回邮件） |

---

## 5. 实施路径

### 5.1 方案选择

| 方案 | 优点 | 缺点 | 建议 |
|------|------|------|------|
| OpenPanel Cloud | 即开即用，无需运维 | 数据不在自己手中 | 初期验证 |
| 自托管 | 数据完全掌控 | 需要 Clickhouse/Redis 基础设施 | 验证价值后迁移 |

**推荐路径**：
1. 先用 Cloud 版本快速验证价值（1-2 个月）
2. 确认价值后评估自托管成本
3. 数据量/隐私要求高时迁移自托管

### 5.2 技术依赖

```yaml
SDK 依赖：
  PC (Electron): @openpanel/web
  Mobile (React Native): @openpanel/react-native
  Server (可选): @openpanel/node

自托管依赖（如需）：
  - Clickhouse（事件存储）
  - PostgreSQL（元数据）
  - Redis（缓存/队列）
```

### 5.3 里程碑

| 阶段 | 内容 | 产出 |
|------|------|------|
| M1 | SDK 集成 + 基础埋点 | 事件数据可查询 |
| M2 | 核心仪表板搭建 | 日活/功能使用率看板 |
| M3 | 漏斗 + 留存分析 | 转化/留存分析报告 |
| M4 | A/B 测试 + 告警 | 实验平台上线 |

---

## 6. 风险与对策

| 风险 | 影响 | 对策 |
|------|------|------|
| 项目年轻，稳定性未知 | 可能有 Bug | 先小范围测试，关注社区活跃度 |
| 自托管运维成本 | 增加基础设施负担 | 先用 Cloud，验证后再考虑 |
| 埋点维护成本 | 事件定义混乱 | 建立埋点规范，代码审查 |
| 数据量增长 | 存储成本上升 | 设置数据保留策略 |

---

## 7. 替代方案对比

| 方案 | 优点 | 缺点 | 成本 |
|------|------|------|------|
| **OpenPanel** | 开源、隐私优先、功能全 | 较新 | 免费/自托管成本 |
| PostHog | 功能最全（含 Session Replay） | 更重，自托管复杂 | Cloud $450/月起 |
| Mixpanel | 功能成熟，生态丰富 | 闭源，数据在美国 | $25-833/月 |
| Amplitude | 企业级，功能强大 | 价格高，闭源 | 定制报价 |
| Plausible | 轻量，隐私优先 | 功能简单，无产品分析 | $9/月起 |

**结论**：OpenPanel 是当前最佳选择，兼顾功能、成本、隐私和技术契合度。

---

## 8. 参考资源

- [OpenPanel 官网](https://openpanel.dev/)
- [OpenPanel GitHub](https://github.com/Openpanel-dev/openpanel)
- [OpenPanel 文档](https://openpanel.dev/docs)
- [自托管指南](https://openpanel.dev/docs/self-hosting/self-hosting)
