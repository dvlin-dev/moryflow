# 需求文档

## 简介

本文档定义了 Mobile 端编辑器迁移的需求规格。目标是将 PC 端基于 Tiptap 的富文本编辑器迁移到 React Native 环境，替换当前基于 `@expensify/react-native-live-markdown` 的简单 Markdown 编辑器，实现跨平台编辑器体验一致性。

当前 Mobile 端使用的是纯文本 Markdown 编辑器，功能有限且体验不佳。PC 端已有成熟的 Tiptap 编辑器实现，包含丰富的扩展（表格、图片、代码块、任务列表等）。本次迁移需要评估并选择最佳的技术方案，在 React Native 环境中复用或适配 PC 端的编辑器能力。

## 术语表

- **Tiptap**: 基于 ProseMirror 的现代富文本编辑器框架，PC 端当前使用的编辑器
- **WebView**: React Native 中用于嵌入 Web 内容的组件
- **react-native-webview**: React Native 官方推荐的 WebView 实现库
- **Bridge（桥接层）**: WebView 与 React Native 之间的通信桥接层
- **ProseMirror**: Tiptap 底层依赖的编辑器引擎
- **Markdown**: 轻量级标记语言，用于文档存储格式
- **WYSIWYG（所见即所得）**: 编辑时即可看到最终效果的编辑器类型
- **原生模块**: React Native 原生模块，用于调用平台特定功能

## 需求列表

### 需求 1：富文本编辑能力

**用户故事：** 作为移动端用户，我希望使用与 PC 端类似的富文本编辑器，以便在不同平台上获得一致的编辑体验。

#### 验收标准

1. 当用户在移动端打开笔记时，编辑器系统应显示具有格式化功能的所见即所得编辑器
2. 当用户应用文本格式（加粗、斜体、下划线）时，编辑器系统应立即渲染格式化后的文本
3. 当用户创建标题时，编辑器系统应以适当的视觉样式显示标题
4. 当用户创建列表（有序、无序、任务列表）时，编辑器系统应以正确的缩进和标记渲染列表
5. 当用户插入代码块时，编辑器系统应显示带有语法高亮的代码

### 需求 2：性能要求

**用户故事：** 作为移动端用户，我希望编辑器加载快速、响应流畅，以便能够无障碍地编辑笔记。

#### 验收标准

1. 当编辑器初始化时，编辑器系统应在中端设备上 2 秒内完成加载
2. 当用户输入文字时，编辑器系统应以低于 100ms 的延迟显示字符
3. 当用户滚动长文档时，编辑器系统应保持 60fps 的滚动性能
4. 当编辑器空闲时，编辑器系统应消耗少于 100MB 的内存

### 需求 3：原生输入支持

**用户故事：** 作为移动端用户，我希望使用原生键盘和输入法，以便能够高效地使用自动纠错和输入建议进行输入。

#### 验收标准

1. 当用户聚焦编辑器时，编辑器系统应显示启用自动纠错的原生键盘
2. 当用户使用语音输入时，编辑器系统应接受并插入转录的文本
3. 当用户使用表情键盘时，编辑器系统应在光标位置插入选中的表情
4. 当用户使用文本选择手势时，编辑器系统应以原生选择手柄响应

### 需求 4：图片支持

**用户故事：** 作为移动端用户，我希望在笔记中插入和查看图片，以便创建丰富的多媒体内容。

#### 验收标准

1. 当用户点击图片按钮时，编辑器系统应提供拍照或选择图片的选项
2. 当用户选择图片时，编辑器系统应在光标位置插入图片
3. 当用户查看已插入的图片时，编辑器系统应以适当的尺寸显示图片
4. 当用户点击图片时，编辑器系统应显示图片操作选项（调整大小、删除）

### 需求 5：表格支持

**用户故事：** 作为移动端用户，我希望创建和编辑表格，以便在笔记中组织结构化数据。

#### 验收标准

1. 当用户插入表格时，编辑器系统应创建指定行列数的表格
2. 当用户点击表格单元格时，编辑器系统应允许编辑单元格内容
3. 当用户添加行或列时，编辑器系统应在指定位置插入新行或列
4. 当用户删除行或列时，编辑器系统应移除指定的行或列

### 需求 6：自动保存与数据持久化

**用户故事：** 作为移动端用户，我希望编辑内容能够自动保存，以便不会丢失我的工作。

#### 验收标准

1. 当用户进行更改时，编辑器系统应在 1 秒内将更改持久化到本地存储
2. 当用户关闭编辑器时，编辑器系统应在关闭前保存所有待处理的更改
3. 当用户重新打开笔记时，编辑器系统应完全恢复保存时的内容
4. 当编辑器序列化内容时，编辑器系统应转换为 Markdown 格式进行存储
5. 当编辑器反序列化内容时，编辑器系统应解析 Markdown 并渲染为富文本

### 需求 7：移动端工具栏

**用户故事：** 作为移动端用户，我希望有一个易于在触摸屏上使用的格式化工具栏，以便能够轻松地格式化文本。

#### 验收标准

1. 当用户选择文本时，编辑器系统应在选区附近显示浮动工具栏
2. 当用户点击工具栏按钮时，编辑器系统应将相应格式应用到选中的文本
3. 当键盘可见时，编辑器系统应将工具栏定位在键盘上方
4. 当用户滚动时，编辑器系统应隐藏浮动工具栏以避免遮挡

### 需求 8：代码复用与可维护性

**用户故事：** 作为开发者，我希望编辑器实现具有可维护性并与 PC 端共享代码，以便减少重复和 bug。

#### 验收标准

1. 当实现编辑器时，编辑器系统应尽可能复用 PC 代码库中的 Tiptap 扩展
2. 当 PC 端编辑器添加新功能时，移动端编辑器应能够以最小的更改采用这些功能
3. 当修复共享代码中的 bug 时，修复应同时应用于 PC 和移动端编辑器
4. 当编辑器与 React Native 通信时，桥接层应使用定义良好的消息协议

### 需求 9：WebView 集成架构

**用户故事：** 作为开发者，我希望有一个清晰的基于 WebView 的编辑器集成架构，以便实现稳健且可调试。

#### 验收标准

1. 当 WebView 加载时，编辑器系统应注入 Tiptap 编辑器 bundle
2. 当 React Native 发送命令时，桥接层应在 WebView 编辑器中执行该命令
3. 当编辑器状态变化时，桥接层应通知 React Native 该变化
4. 当 WebView 中发生错误时，桥接层应向 React Native 报告错误以便处理

