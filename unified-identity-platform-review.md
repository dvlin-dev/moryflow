# 统一身份平台评估与建议

> 评估基于 `unified-identity-platform.md` 与当前仓库实现（截至目前的 Monorepo 状态）。

## 结论摘要

- 方案总体合理且可执行：独立产品域名 + 统一 auth 服务 + 共享用户数据，`aiget.dev` 作为聚合入口，符合当前业务目标。
- 设计中存在若干一致性缺口（域名/路径、认证接入模式、订阅与钱包模型细节），需要在落地前补齐关键约束。
- 当前实现仍处于“各产品独立身份系统”的阶段，跨产品统一的类型与规范已建立雏形，但与实际数据模型/接口存在明显不一致，需要尽快对齐，否则迁移成本会指数级增长。

---

## 1. 方案合理性评估

### 1.1 合理之处（可保留）

- **统一身份 + 钱包 + 权益层的分层设计**：将用户/订阅/积分抽离为基础设施，是多产品平台的主流做法。
- **独立域名 + 聚合入口 + 统一用户系统**：保留品牌独立性，同时集中用户资产与入口管理，符合实际使用场景。
- **积分体系 + 订阅等级统一**：便于跨产品扩展与交叉销售，也方便未来统一控制台。
- **钱包交易账本 + 用量日统计的组合**：同时满足审计与运营统计需求。
- **API Key 统一管理 + 哈希存储**：安全性与最小权限原则方向正确。
- **迁移按阶段推进**：先核心产品试点，再逐步接入，降低风险。

### 1.2 设计中需要补齐/澄清的关键点

- **域名与路径不一致**：文档中同时出现 `/api/v1/...` 与 `/{product}.aiget.dev/v1/...`，以及 `auth.aiget.dev` vs `aiget.dev` 的混用。
- **认证接入模式未明确**：当前目标是“统一 auth 服务 + 共享用户数据 + 各产品自有登录页面与本域会话”，需要在文档中固化为唯一方案。
- **钱包幂等与一致性**：扣减/退款需要 `idempotencyKey` 或 `referenceId` 的强唯一约束；仅靠余额字段会存在重试与并发偏差。
- **订阅升级/降级与周期规则**：缺少对升降级、试用、按比例计费（proration）的明确约束与数据模型字段。
- **权益模型粒度**：`ProductEntitlement` 仅通过 `product + feature` 约束，缺少数量/限制/作用域的统一表达（如并发上限、速率、容量）。
- **服务间调用策略**：全部走公网域名是可行方案，但必须补齐 mTLS/签名/限流/重试策略，否则可用性与安全风险较高。
- **账号合并与冲突策略**：迁移时同邮箱、多产品用户合并策略需要提前定义，文档尚未覆盖。

---

## 2. 当前实现评估

### 2.1 已有基础（可复用的部分）

- **统一类型雏形已存在**：`packages/types` 已定义平台统一订阅与钱包类型，便于后续对齐。
- **各产品已有 Better Auth 实现**：认证流程具备可迁移基础。
- **Moryflow 已有积分与订阅流水**：包含订阅积分、购买积分、每日用量等结构，可作为统一钱包与用量的参考。

### 2.2 关键不一致（影响统一身份落地）

- **订阅等级不一致**：
  - Fetchx: `FREE/BASIC/PRO/TEAM`
  - Memox: `FREE/HOBBY/ENTERPRISE`
  - Moryflow: `free/starter/basic/pro/license`
  - 平台类型: `FREE/STARTER/PRO/MAX`
- **API Key 前缀与命名不一致**：类型定义中存在 `lx_`（Flowx）而非 `mf_`，产品内实际使用 `lk_/mk_` 等前缀。
- **钱包/积分模型割裂**：
  - Fetchx/Memox 使用“配额 + 订单”模型
  - Moryflow 使用“订阅积分 + 购买积分 + 每日用量”模型
  - 平台设计为“统一钱包 + 交易账本 + 权益层”
- **接口路径与域名不一致**：`packages/api` 仍指向 `server.moryflow.com` 与 `/api/...` 路径，未对齐新域名规范。
- **统一认证服务尚未落地**：`packages/auth` 仍为占位配置，`apps/auth/server`、`apps/console`、`apps/admin` 尚未创建。

### 2.3 合理但需注意的当前实现点

- 各产品在创建用户时自动初始化订阅/配额/默认 API Key，流程合理，但迁移时需防止重复创建与数据冲突。
- Moryflow 的积分与用量体系更接近统一平台思路，可作为“目标参考”，但仍需升级为全平台可用模型。

---

## 3. 建议（按优先级）

### P0（立即对齐，避免后续返工）

1. **统一域名与 API 路径规范**：固定 `auth.aiget.dev` 作为身份入口，明确 `/v1` 或 `/api/v1` 的唯一标准。
2. **明确认证接入模式**：统一 auth 服务提供注册/登录/第三方授权能力，各产品保留独立登录页面与本域会话。
3. **定义订阅等级映射表**：从现有三套等级映射到统一 `FREE/STARTER/PRO/MAX`，并冻结旧等级。
4. **制定账号合并策略**：
   - 明确邮箱冲突处理规则
   - 明确同邮箱多账户策略
   - 明确旧用户 ID → 新 ID 的映射策略
5. **API Key 前缀与产品命名统一**：修正 `lx_`、`lk_` 等遗留前缀，统一到 `mf_/fx_/mx_/sx_/ag_`。

### P1（核心设计补强）

1. **钱包改为“账本 + 幂等”模型**：
   - 交易必须带 `referenceId`/`idempotencyKey`
   - 使用事务 + 乐观锁/行锁确保并发安全
2. **订阅生命周期约束**：明确升降级、试用期、过期/宽限期状态转换逻辑。
3. **权益模型标准化**：
   - `ProductEntitlement` 应支持 `limit/quantity/scope` 字段
   - 配合配置表统一管理产品功能上限
4. **服务间安全协议落地**：
   - mTLS 或签名校验
   - 每服务独立密钥 + 定期轮换
   - 限流与熔断策略

### P2（可选优化）

1. **引入使用量定价配置**：统一定义每个产品操作的“积分消耗规则”。
2. **建设统一审计日志与追踪**：钱包扣减、订阅变更、权益授权需可追踪。
3. **迁移过程双写/比对**：切换前双写钱包/订阅数据，校验一致后再完全切换。

---
